#line 203 "c:\harb16\include\hbclass.ch"
DECLARE HBClass  New( cName AS STRING, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS OBJECT  Instance() AS OBJECT  AddClsMethod( cName AS STRING, @MethodName(), nScope AS NUMERIC, n2 AS NUMERIC, n3 AS NUMERIC )  AddMultiClsData( cType AS STRING, uVal, nScope AS NUMERIC, aDatas AS ARRAY OF STRING )  AddMultiData( cType AS STRING, uVal, nScope AS NUMERIC, aDatas AS ARRAY OF STRING, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS STRING, @MethodName(), nScope AS NUMERIC )  AddInLine( cName AS STRING, bBlock AS CODEBLOCK, nScope AS NUMERIC )  AddVirtual( cName AS STRING )
#line 91 "C:\FWH16\INCLUDE\Fivewin.ch"
         EXTERNAL FW_GT
















extern errorsys











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 10 "abmart.prg"
MEMVAR oApp

STATIC oQryBrw,oQry, oQry2, oQry3, oQry4, oQry5, oQry6, oQry7 , oWnd1, oBrw, oDlg, cVentana,oBrw1, oQryArt,oQryPun , lTipoArt
PROCEDURE Artic(cPermisos)
LOCAL oBar, hHand, oGetSeek, cSeek := SPACE(50), oPop2
cVentana := PROCNAME()
IF ASCAN(oApp:aVentanas,cVentana) > 0
   hHand := ASCAN(oApp:aVentanas,cVentana)
   oApp:oWnd:Select(hHand)
   oApp:oWnd:oWndClient:aWnd[hHand]:Restore()
   RETURN
ENDIF
lTipoArt := nil
AADD(oApp:aVentanas,cVentana)



oQryBrw:= oApp:oServer:Query("SELECT codigo,codigopro,nombre,stockact,Preciocos,Precioven,reventa,fecmod,observa,nosale"+ " FROM ge_"+oApp:cId+"articu "+ "ORDER BY nombre")
oPop2 := MenuBegin( .T.,,, .F., .F.,,,,,,,,,, .F.,, .F., .F., .F., .F.,, ,,,,,, .F.,, .F., .F.,,,, )
     MenuAddItem( "Todos los productos",, .F.,, {|oMenuItem|FiltrarVen(nil)},,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F., )
     MenuAddItem( "Solo Vendibles",, .F.,, {|oMenuItem|FiltrarVen(.T.)},,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F., )
     MenuAddItem( "Solo No vendibles",, .F.,, {|oMenuItem|FiltrarVen(.F.)},,,,,,, .F.,,, .F., ,.F., .F.,,,,,,,,,, .F., .F.,,,,,,, ,, .F., .F., .F., )
MenuEnd()

   oQry2  := oApp:oServer:Query( "SELECT codigo,nombre,alias FROM ge_"+oApp:cId+"provee ORDER BY codigo")
   oQry3  := oApp:oServer:Query( "SELECT codigo,nombre,tasa FROM ge_"+oApp:cId+"ivas ORDER BY codigo")
   oQry4  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"marcas ORDER BY codigo")
   oQry5  := oApp:oServer:Query( "SELECT codigo,nombre,depto FROM ge_"+oApp:cId+"rubros ORDER BY codigo")
   oQry6  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"deptos ORDER BY codigo")
   oQry7  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"empresas ORDER BY codigo")



  oWnd1 := TMdiChild():New( 05, 05, 50, 50, "A/B/M de Articulos: Solo articulos vendibles",,, oApp:oWnd, oApp:oIco, .F.,,,,, .F., .F.,,, !.F., !.F., !.F., !.T.,, )
         oBar := TBar():New( oWnd1, 60, 60, .F.,,, .F., .T., .F.,,, ,,, .F.,, .F. )



         TBtnBmp():NewBar( "ALTA",,,,, {|This|(Formu( .T. ),oBrw:Refresh())}, .F., oBar, .F., {||("A"$cPermisos)}, "Agregar Registro", .F.,, "(Formu( .T. ),oBrw:Refresh())",, "Alta",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "MODI",,,,, {|This|(Formu( .F. ,oQryBrw:codigo),oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "M"$cPermisos)}, "Modificar Registro", .F.,, "(Formu( .F. ,oQryBrw:codigo),oBrw:Refresh())",, "Modifica",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "BAJA",,,,, {|This|(Baja( ),oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "B"$cPermisos)}, "Eliminar Registro", .F.,, "(Baja( ),oBrw:Refresh())",, "Baja",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "DUPL",,,,, {|This|(Duplicar( ),oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "A"$cPermisos)}, "Duplicar Registro", .F.,, "(Duplicar( ),oBrw:Refresh())",, "Duplicar",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "EXCE",,,,, {|This|oBrw:ToExcel()}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "E"$cPermisos)}, "Exportar a Excel", .F.,, "oBrw:ToExcel()",, "Exporta",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "IMPR",,,,, {|This|oBrw:Report("Reporte de Articulos",.T.,.F.)}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "R"$cPermisos)}, "Imprimir Planilla", .F.,, 'oBrw:Report("Reporte de Articulos",.T.,.F.)',, "Reporte",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "FILT",,,,, {|This|(FILT(),oBrw:Refresh())}, .F., oBar, .F.,, "Filtrar Articulos", .F.,, "(FILT(),oBrw:Refresh())",, "Filtrar",,,,, oPop2, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "PRECIO",,,,, {|This|(Historial(),oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "M"$cPermisos)}, "Ver historial de precios", .F.,, "(Historial(),oBrw:Refresh())",, "Historial",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "IMPOR",,,,, {|This|(Importar(), oBrw:Refresh())}, .F., oBar, .F., {||("A"$cPermisos)}, "Importar Registros", .F.,, "(Importar(), oBrw:Refresh())",, "Importar",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "ARTI",,,,, {|This|(Cambiar(), oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "M"$cPermisos)}, "Cambiar el Codigo / Codigo de barras", .F.,, "(Cambiar(), oBrw:Refresh())",, "Cambiar",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "CODBAR1",,,,, {|This|(BuscarxCod(), oBrw:Refresh())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "M"$cPermisos)}, "Buscar por codigo", .F.,, "(BuscarxCod(), oBrw:Refresh())",, "Buscar",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "POS",,,,, {|This|(HistorialVentas())}, .F., oBar, .F., {||(oQryBrw:RecCount()>0 .AND. "A"$cPermisos)}, "Ver el historial de ventas", .F.,, "(HistorialVentas())",, "Hist.Ventas",,,,,, Upper("TOP"),,, .F. )



         TBtnBmp():NewBar( "PROD",,,,, {|This|(RepRecetas())}, .F., oBar, .F., {||("R"$cPermisos)}, "Reporte de Recetas", .F.,, "(RepRecetas())",, "Lista Rec.",,,,,, Upper("TOP"),,, .F. )




         TBtnBmp():NewBar( "SALE",,,,, {|This|oWnd1:End()}, .F., oBar, .F.,, "Cerrar Ventana", .F.,, "oWnd1:End()",, "Cerrar",,,,,, Upper("TOP"),,, .F. )
   oWnd1:bGotFocus := { || oDlg:SetFocus}
   oWnd1:bResized := { || Incrusta( oWnd1, oDlg, .T.) }
     oDlg = TDialog():New(,,,,, "ABMS",, .F.,,,,, oWnd1, .F.,,,,,, .F.,, "oDlg", nil, )
     IF "M"$cPermisos




         oBrw := XbrowseNew( oDlg, 0, 0,,,, {"Código art.","Cód.Prov.","Nombre","Stock","Precio costo","P. Venta 1","P. Venta 2","Fecha Cambio","Observaciones"}, {90,70,230,60,70,75,75,70,200},, {|nRow,nCol,nFlags|(IF("M"$cPermisos,Formu( .F.,oQryBrw:codigo),nil))},,,,,,, .F., oQryBrw,, .F.,, .F., 111, .T., .F. ,, {"Codigo","codigopro","nombre","stockact","Preciocos","Precioven","reventa","fecmod","Observa"},,, .F., .F., .F., .F.,,,,, .F., .F., "oBrw", )
         oGetSeek := TGet():ReDefine( 113, { | u | If( PCount()==0, cSeek, cSeek:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,,, "cSeek",,,, )
         PintaBrw(oBrw,9)
     ELSE




         oBrw := XbrowseNew( oDlg, 0, 0,,,, {"Código art","Cód.Prov.","Nombre","Precio costo","P. Venta 1","P. Venta 2","Fecha Cambio","Observaciones"}, {90,70,350,70,70,70,70,200},, {|nRow,nCol,nFlags|(IF("M"$cPermisos,Formu( .F.,oQryBrw:codigo),nil))},,,,,,, .F., oQryBrw,, .F.,, .F., 111, .T., .F. ,, {"Codigo","codigopro","nombre","Preciocos","Precioven","reventa","fecmod","observa"},,, .F., .F., .F., .F.,,,,, .F., .F., "oBrw", )
         oGetSeek := TGet():ReDefine( 113, { | u | If( PCount()==0, cSeek, cSeek:= u ) }, oDlg,,,,,,,,, .F.,,, .F., .F.,,,,,,, "cSeek",,,, )
         PintaBrw(oBrw,8)
     ENDIF



     oBrw:bClrStd := { || IF(oQryBrw:nosale,{ 0, ( 255 + ( 50 * 256 ) + ( 50 * 256 * 256 ) ) }, If( oBrw:KeyNo() % 2 == 0,  { 0, ( 193 + ( 221 * 256 ) + ( 255 * 256 * 256 ) ) },  { 0, ( 221 + ( 245 * 256 ) + ( 255 * 256 * 256 ) ) } )) }

     oQryBrw:bOnChangePage := {|| oBrw:Refresh() }

     oBrw:bKeyDown := {|nKey,nFlags| Acelerador2(nKey,oBar, oBrw,cPermisos,8)}
     oGetSeek:bKeyDown := { |nKey,nFlag| FiltraArt(oQryBrw, oGetSeek, oBrw, nKey) }


     oDlg:Activate( oDlg:bLClicked, oDlg:bMoved, oDlg:bPainted, .T., {|Self|(oWnd1:End())}, ! .T., {|Self|(oGetSeek:SetFocus(),oDlg:Move(0,0),FiltrarVen(.T.))}, oDlg:bRClicked,,, )
   oWnd1:Activate(, oWnd1:bLClicked, oWnd1:bRClicked, oWnd1:bMoved, oWnd1:bResized, oWnd1:bPainted, oWnd1:bKeyDown, oWnd1:bInit := { | Self | Incrusta( oWnd1, oDlg, .T.) },,,,,,,,, {||(cerrar())},, oWnd1:bLButtonUp, .F. )
RETURN





STATIC FUNCTION Formu (lAlta,nCodArt)


LOCAL oGet := ARRAY(53), oBot := ARRAY(8), oForm, lRta := .F., aCor, base, cProve:=SPACE(30), nNeto, cIvaNom:=SPACE(30), cMarc:=SPACE(30), cRub:=SPACE(30), cDept:=SPACE(30), cEmp:=SPACE(30), nIva,oError,nPrecioven:=0,nPreciocos:=0, nova1,nova2,oSay:=ARRAY(8),oGru:=ARRAY(2), mstock := 0, lActualizaGrupo := .F.
IF !lAlta .AND. nCodArt = 0
   RETURN nil
ENDIF
IF lAlta
   oQry:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu LIMIT 0")
   base := oQry:GetBlankRow()
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"articu")
   base:iva := 5
   base:prov  := oQry2:codigo
   base:marca := oQry4:codigo
   base:rubro := oQry5:codigo
   base:depto := oQry6:codigo
   base:empresa := oQry7:codigo
   base:siniva := .T.
   ELSE
   oQry:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu WHERE codigo = " + ClipValue2Sql(nCodArt))
   base := oQry:GetRowObj()

   nPrecioven:=base:precioven
   nPreciocos:=base:preciocos
   mstock := base:stockact
ENDIF
   oQry2  := oApp:oServer:Query( "SELECT codigo,nombre,alias FROM ge_"+oApp:cId+"provee WHERE codigo = "+str(base:prov))
   oQry3  := oApp:oServer:Query( "SELECT codigo,nombre,tasa FROM ge_"+oApp:cId+"ivas WHERE codigo = "+str(base:iva))
   oQry4  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"marcas WHERE codigo = "+str(base:marca))
   oQry5  := oApp:oServer:Query( "SELECT codigo,nombre,depto FROM ge_"+oApp:cId+"rubros WHERE codigo = "+str(base:rubro))
   oQry6  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"deptos WHERE codigo = "+str(base:depto))
   oQry7  := oApp:oServer:Query( "SELECT codigo,nombre FROM ge_"+oApp:cId+"empresas WHERE codigo = "+str(base:empresa))

   cProve := oQry2:nombre
   cIvaNom := STR(oQry3:tasa,6,2) + "%"
   cMarc := oQry4:nombre
   cRub := oQry5:nombre
   cDept := oQry6:nombre
   cEmp := oQry7:nombre


base:observa := IF(EMPTY(base:observa),SPACE(255),ALLTRIM(base:observa)+SPACE(255-LEN(ALLTRIM(base:observa))))

while .T.
oForm = TDialog():New(,,,, IF(lAlta,"Alta","Modificacion") + " de Articulo", "ABMART1",, .F.,,,,, oWnd1, .F.,,,,,, .F.,, "oForm", nil, )
 oForm:lHelpIcon := .F.

 oGet[01] := TGet():ReDefine( 100, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,, "99999999999999",,,,,,, .F., {||(lAlta)},, .F., .F.,,,,,,, "base:codigo",,,, )

  oGet[02] := TGet():ReDefine( 101, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,, "@!", {||(base:nombre<>space(30))},,,,,, .F.,,, .F., .F.,,,,,,, "base:nombre",,,, )
  oGet[03] := TGet():ReDefine( 102, { | u | If( PCount()==0, base:nomregi, base:nomregi:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:nomregi",,,, )
  oSay[8] := TSay():ReDefine( 4002,, oForm,,,, .F.,, .F., .F., )
  oGet[51] := TGet():ReDefine( 4017, { | u | If( PCount()==0, base:codigopro, base:codigopro:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:codigopro",,,, )
  oGet[46] := TCheckBox():ReDefine( 4012, { | u | If( PCount()==0, base:endolares, base:endolares:= u ) }, oForm,,,,,,, .F.,, )
  oGet[52] := TCheckBox():ReDefine( 4011, { | u | If( PCount()==0, base:pesable, base:pesable:= u ) }, oForm,,,,,,, .F.,, )
  oGet[34] := TCheckBox():ReDefine( 103, { | u | If( PCount()==0, base:nosale, base:nosale:= u ) }, oForm,,,,,,, .F.,, )

  oGru[1] := TGroup():ReDefine( 401,, oForm,,,, )
  oGet[44] := TCheckBox():ReDefine( 4007, { | u | If( PCount()==0, base:mprima, base:mprima:= u ) }, oForm,,,,,,, .F.,, )
  oGet[45] := TCheckBox():ReDefine( 4008, { | u | If( PCount()==0, base:produccion, base:produccion:= u ) }, oForm,,,,,,, .F., {||(!base:stockotro)}, )
  oBot[3] := TButton():ReDefine( 4009, {||(Reseta(base,oForm),oGet[06]:Refresh())}, oForm,,, .F., {|| (base:produccion)},,, .F. )




  oGet[04] := TGet():ReDefine( 104, { | u | If( PCount()==0, base:prov, base:prov:= u ) }, oForm,, "99999", {||(Buscar(oQry2,oForm,oGet[4],oGet[5]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[04]:cText:= 0, Buscar(oQry2,oForm,oGet[4],oGet[5])) }, "BUSC1", "base:prov",,,, )
  oGet[05] := TGet():ReDefine( 105, { | u | If( PCount()==0, cProve, cProve:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cProve",,,, )


  oGet[21] := TGet():ReDefine( 122, { | u | If( PCount()==0, base:marca, base:marca:= u ) }, oForm,, "9999", {||(Buscar(oQry4,oForm,oGet[21],oGet[22]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[21]:cText:= 0, Buscar(oQry4,oForm,oGet[21],oGet[22])) }, "BUSC1", "base:marca",,,, )
  oGet[22] := TGet():ReDefine( 123, { | u | If( PCount()==0, cMarc, cMarc:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cMarc",,,, )


  oGet[23] := TGet():ReDefine( 124, { | u | If( PCount()==0, base:rubro, base:rubro:= u ) }, oForm,, "9999", {||(Buscar(oQry5,oForm,oGet[23],oGet[24]) .AND. (oGet[25]:cText:= oQry5:depto) <> "XXX" .AND. Buscar(oQry6,oForm,oGet[25],oGet[26]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[23]:cText:= 0, Buscar(oQry5,oForm,oGet[23],oGet[24]),oGet[25]:cText:= oQry5:depto,Buscar(oQry6,oForm,oGet[25],oGet[26])) }, "BUSC1", "base:rubro",,,, )
  oGet[24] := TGet():ReDefine( 125, { | u | If( PCount()==0, cRub, cRub:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cRub",,,, )


  oGet[27] := TGet():ReDefine( 126, { | u | If( PCount()==0, base:empresa, base:empresa:= u ) }, oForm,, "9999", {||(Buscar(oQry7,oForm,oGet[27],oGet[28]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[27]:cText:= 0, Buscar(oQry7,oForm,oGet[27],oGet[28])) }, "BUSC1", "base:empresa",,,, )
  oGet[28] := TGet():ReDefine( 127, { | u | If( PCount()==0, cEmp, cEmp:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cEmp",,,, )


  oGet[25] := TGet():ReDefine( 128, { | u | If( PCount()==0, base:depto, base:depto:= u ) }, oForm,, "9999", {||(Buscar(oQry6,oForm,oGet[25],oGet[26]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[25]:cText:= 0, Buscar(oQry6,oForm,oGet[25],oGet[26])) }, "BUSC1", "base:depto",,,, )
  oGet[26] := TGet():ReDefine( 129, { | u | If( PCount()==0, cDept, cDept:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cDept",,,, )

  oBot[4] := TButton():ReDefine( 301, {||AltaMar()}, oForm,,, .F.,,,, .F. )
  oBot[5] := TButton():ReDefine( 302, {||AltaRub()}, oForm,,, .F.,,,, .F. )
  oBot[6] := TButton():ReDefine( 303, {||AltaEmp()}, oForm,,, .F.,,,, .F. )
  oBot[7] := TButton():ReDefine( 304, {||AltaDep()}, oForm,,, .F.,,,, .F. )


  oGru[2] := TGroup():ReDefine( 402,, oForm,,,, )
  oSay[3] := TSay():ReDefine( 4066,, oForm,,,, .F.,, .F., .F., )
  oSay[4] := TSay():ReDefine( 4067,, oForm,,,, .F.,, .F., .F., )
  oSay[5] := TSay():ReDefine( 4069,, oForm,,,, .F.,, .F., .F., )
  oSay[6] := TSay():ReDefine( 4070,, oForm,,,, .F.,, .F., .F., )
  oSay[7] := TSay():ReDefine( 4071,, oForm,,,, .F.,, .F., .F., )
  oGet[35] := TGet():ReDefine( 135, { | u | If( PCount()==0, base:unimed, base:unimed:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:unimed",,,, )
  oGet[47] := TGet():ReDefine( 500, { | u | If( PCount()==0, base:medida, base:medida:= u ) }, oForm,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:medida",,,, )
  oGet[48] := TGet():ReDefine( 501, { | u | If( PCount()==0, base:entero, base:entero:= u ) }, oForm,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:entero",,,, )
  oGet[49] := TGet():ReDefine( 502, { | u | If( PCount()==0, base:uxbulto, base:uxbulto:= u ) }, oForm,, "9999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:uxbulto",,,, )

  oGet[50] := TGet():ReDefine( 503, { | u | If( PCount()==0, base:pxbulto, base:pxbulto:= u ) }, oForm,, "999999999.99", {||((oGet[06]:cText:= (base:pxbulto/base:uxbulto)) <> "xxx")},,,,,, .F.,,, .F., .F.,,,,,,, "base:pxbulto",,,, )


  oGet[46] := TCheckBox():ReDefine( 4003, { | u | If( PCount()==0, base:siniva, base:siniva:= u ) }, oForm,,,,,,, .F.,, )
  oGet[06] := TGet():ReDefine( 106, { | u | If( PCount()==0, base:precossiva, base:precossiva:= u ) }, oForm,, "999999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:precossiva",,,, )
  oGet[07] := TGet():ReDefine( 107, { | u | If( PCount()==0, base:desc1, base:desc1:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc1",,,, )
  oGet[08] := TGet():ReDefine( 108, { | u | If( PCount()==0, base:desc2, base:desc2:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc2",,,, )
  oGet[09] := TGet():ReDefine( 109, { | u | If( PCount()==0, base:desc3, base:desc3:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc3",,,, )
  oGet[10] := TGet():ReDefine( 110, { | u | If( PCount()==0, base:desc4, base:desc4:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc4",,,, )
  oGet[11] := TGet():ReDefine( 111, { | u | If( PCount()==0, base:desc5, base:desc5:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc5",,,, )

  oGet[39] := TGet():ReDefine( 112, { | u | If( PCount()==0, nNeto, nNeto:= u ) }, oForm,, "999999999.99",,,,,,, .F., {||(CalcularNeto(base,oGet))},, .F., .F.,,,,,,, "nNeto",,,, )

  oGet[12] := TGet():ReDefine( 113, { | u | If( PCount()==0, base:impint, base:impint:= u ) }, oForm,, "99999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:impint",,,, )
  oGet[13] := TGet():ReDefine( 114, { | u | If( PCount()==0, base:flete, base:flete:= u ) }, oForm,, "99999.9",,,,,,, .F.,,, .F., .F.,,,,,,, "base:flete",,,, )




  oGet[14] := TGet():ReDefine( 115, { | u | If( PCount()==0, base:iva, base:iva:= u ) }, oForm,, "99", {||(Buscar(oQry3,oForm,oGet[14]) .AND.  (oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx")},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[14]:cText:= 0, (Buscar(oQry3,oForm,oGet[14]) .AND.  (oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx")) }, "BUSC1", "base:iva",,,, )
  oGet[15] := TGet():ReDefine( 116, { | u | If( PCount()==0, cIvaNom, cIvaNom:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cIvaNom",,,, )


  oGet[16] := TGet():ReDefine( 117, { | u | If( PCount()==0, base:preciocos, base:preciocos:= u ) }, oForm,, "999999999.99",,,,,,, .F., {||((oGet[16]:cText:= nNeto + base:impint + nNeto * (base:flete/100) + ((nNeto * oQry3:tasa )/100)) = "-999999")},, .F., .F.,,,,,,, "base:preciocos",,,, )

  oGet[17] := TGet():ReDefine( 118, { | u | If( PCount()==0, base:porcentaje, base:porcentaje:= u ) }, oForm,, "999.99", {||(CalcularPrecio(oGet,base,.T.))},,,,,, .F.,,, .F., .F.,,,,,,, "base:porcentaje",,,, )

  oGet[18] := TGet():ReDefine( 119, { | u | If( PCount()==0, base:porcentajerev, base:porcentajerev:= u ) }, oForm,, "999.99", {||(CalcularPrecio(oGet,base,.F.))},,,,,, .F.,,, .F., .F.,,,,,,, "base:porcentajerev",,,, )
  oGet[19] := TGet():ReDefine( 120, { | u | If( PCount()==0, base:reventa, base:reventa:= u ) }, oForm,, "999999999.999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:reventa",,,, )
  oGet[20] := TGet():ReDefine( 121, { | u | If( PCount()==0, base:precioven, base:precioven:= u ) }, oForm,, "999999999.999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:precioven",,,, )



  oSay[1] := TSay():ReDefine( 801,, oForm,,,, .F.,, .F., .F., )
  oGet[41] := TGet():ReDefine( 1300, { | u | If( PCount()==0, nova1, nova1:= u ) }, oForm,,,,,,,,, .F.,,, .F., .F.,,,,,,, "nova1",,,, )
  oGet[29] := TGet():ReDefine( 130, { | u | If( PCount()==0, base:fecultcom, base:fecultcom:= u ) }, oForm,,,,,,,,, .F., {||(.F.)},, .F., .F.,,,,,,, "base:fecultcom",,,, )
  oGet[30] := TGet():ReDefine( 131, { | u | If( PCount()==0, base:fecmod, base:fecmod:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "base:fecmod",,,, )
  oSay[2] := TSay():ReDefine( 804,, oForm,,,, .F.,, .F., .F., )
  oGet[42] := TGet():ReDefine( 1311, { | u | If( PCount()==0, nova2, nova2:= u ) }, oForm,,,,,,,,, .F.,,, .F., .F.,,,,,,, "nova2",,,, )


  oGet[31] := TGet():ReDefine( 132, { | u | If( PCount()==0, base:stockmin, base:stockmin:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockmin",,,, )
  oGet[32] := TGet():ReDefine( 133, { | u | If( PCount()==0, base:stockact, base:stockact:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockact",,,, )
  oGet[33] := TGet():ReDefine( 134, { | u | If( PCount()==0, base:stockide, base:stockide:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockide",,,, )
  oGet[53] := TCheckBox():ReDefine( 4005, { | u | If( PCount()==0, base:stockotro, base:stockotro:= u ) }, oForm,,,,,,, .F., {||(!base:produccion)}, )
  oBot[8] := TButton():ReDefine( 4015, {||(Reseta(base,oForm,.F.))}, oForm,,, .F., {|| (base:stockotro)},,, .F. )

  oGet[36] := TGet():ReDefine( 136, { | u | If( PCount()==0, base:observa, base:observa:= u ) }, oForm,,,,,,,,, .F.,,, .F., .F.,,,,,,, "base:observa",,,, )


  oBot[1] := TButton():ReDefine( 137, {||((lRta := .T.), oForm:End() )}, oForm,,, .F.,,, "&Grabar", .F. )

  oBot[2] := TButton():ReDefine( 138, {||((lRta := .F.), oForm:End() )}, oForm,,, .F.,,,, .T. )


oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|(oGet[01]:SetFocus(),EsconderPermisos(oGet,oSay,oGru,oBot))}, oForm:bRClicked,,, )
IF !lRta
   RETURN nil
ENDIF
IF base:preciocos = 0 .OR. base:iva = 0
   msginfo("Campos obligatorios como 'Precio costo' e 'IVA' tienen que estar completos","Atencion!")
   LOOP
ENDIF
IF base:iva <> 3 .AND. base:iva <> 4 .AND. base:iva <> 5
   MsgStop("Tasa de IVA no valida para facturacion","Error")
   LOOP
ENDIF
IF !lAlta
   IF mstock <> oApp:oServer:Query("SELECT stockact FROM ge_"+oApp:cId+"articu WHERE codigo = "+ClipValue2SQL(base:codigo)):stockact
      MsgStop("El stock fue modificado en otra terminal"+CHR(10)+"No se actualizaran los datos. Reintente","Actualice")
      oQryBrw:Refresh()
      oBrw:Refresh()
      RETURN nil
   ENDIF
ENDIF
IF nPrecioven <> base:precioven .OR. nPreciocos <> ROUND(base:preciocos,3)



   oApp:oServer:Execute("INSERT INTO ge_"+oApp:cId+"campre (codigo,preciocos,precossiva,precioven,reventa,fecmod,usuario,ip) "+ "VALUES ("+ClipValue2Sql(base:codigo)+","+ClipValue2Sql(base:preciocos)+","+ ClipValue2Sql(base:precossiva)+","+ClipValue2Sql(base:precioven)+","+ClipValue2Sql(base:reventa)+",CURDATE(),"+ ClipValue2Sql(oApp:usuario)+",'Cambio puntual')")
   base:fecmod := oApp:oServer:Query("SELECT CURDATE() AS fecha"):fecha
   base:horamod := oApp:oServer:Query("SELECT CURTIME() AS hora"):hora
   lActualizaGrupo := .T.
ENDIF
IF !oApp:utilfija
   base:porcentaje := (base:precioven * 100) / base:preciocos - 100
   base:porcentajerev := (base:reventa * 100) / base:preciocos - 100
ENDIF
base:usuario:= oApp:usuario
base:ip     := oApp:cIp
base:nombre := STRTRAN(base:nombre,"'","´")
oQry:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQry:Save()
  IF lAlta .AND. base:stockact <> 0

     oApp:oServer:Insert("ge_"+oApp:cId+"stoman",{"codart","entradas","salidas","fecha","motivo","costo","usuario"}, {base:codigo,base:stockact,0,DATE(),1,base:precossiva,oApp:usuario})
  ENDIF
  IF !lAlta .AND. base:stockact <> mstock


     oApp:oServer:Insert("ge_"+oApp:cId+"stoman",{"codart","entradas","salidas","fecha","motivo","costo","usuario"}, {base:codigo,if(mstock < base:stockact, base:stockact - mstock,0), if(mstock > base:stockact, mstock - base:stockact,0),DATE(),1,base:precossiva,oApp:usuario})
  ENDIF
  oApp:oServer:CommitTransaction()
  IF !lAlta .AND. lActualizaGrupo
     ActualizarGrupo(base)
  ENDIF
  oQryBrw:Refresh(.F.)
  oBrw:Refresh()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil




STATIC FUNCTION ActualizarGrupo(base)
LOCAL nGrupo, oError
nGrupo:= oApp:oServer:Query("SELECT codgru FROM ge_"+oApp:cId+"gruposdet WHERE codart = "+ClipValue2Sql(base:codigo)):codgru
IF nGrupo <> 0
  BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()




















  oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"gruposdet g LEFT JOIN ge_"+oApp:cId+"articu a "+ " ON g.codart = a.codigo AND "+ "    g.codgru = "+ClipValue2Sql(nGrupo)+ " SET a.precossiva = "+ClipValue2Sql(base:precossiva)+","+ "a.desc1      = "+ClipValue2Sql(base:desc1)+","+ "a.desc2      = "+ClipValue2Sql(base:desc2)+","+ "a.desc3      = "+ClipValue2Sql(base:desc3)+","+ "a.desc4      = "+ClipValue2Sql(base:desc4)+","+ "a.desc5      = "+ClipValue2Sql(base:desc5)+","+ "a.impint     = "+ClipValue2Sql(base:impint)+","+ "a.flete      = "+ClipValue2Sql(base:flete)+","+ "a.iva        = "+ClipValue2Sql(base:iva)+","+ "a.preciocos  = "+ClipValue2Sql(base:preciocos)+","+ "a.porcentaje = "+ClipValue2Sql(base:porcentaje)+","+ "a.precioven  = "+ClipValue2Sql(base:precioven)+","+ "a.preciopro  = "+ClipValue2Sql(base:preciopro)+","+ "a.porcentajerev = "+ClipValue2Sql(base:porcentajerev)+","+ "a.reventa    = "+ClipValue2Sql(base:reventa)+","+ "a.fecmod     = CURDATE(),"+ "a.horamod    = CURTIME(),"+ "a.siniva     = "+ClipValue2Sql(base:siniva)+" ")
    oApp:oServer:CommitTransaction()
  RECOVER USING oError
    ValidaError(oError)
  end
ENDIF
RETURN nil



STATIC FUNCTION CalcularNeto(base,oGet)
LOCAL nTotalNeto

nTotalNeto:= IF(base:siniva,base:precossiva,base:precossiva/(1+oQry3:tasa/100))
nTotalNeto:= nTotalNeto - nTotalNeto * (base:desc1/100)
nTotalNeto:= nTotalNeto - nTotalNeto * (base:desc2/100)
nTotalNeto:= nTotalNeto - nTotalNeto * (base:desc3/100)
nTotalNeto:= nTotalNeto - nTotalNeto * (base:desc4/100)
nTotalNeto:= nTotalNeto - nTotalNeto * (base:desc5/100)

oGet[39]:cText:= nTotalNeto

RETURN .F.



FUNCTION Reseta(base,oForm,lReceta)

LOCAL oDlgR,oGet:=ARRAY(5),oBot:=ARRAY(5),oBrwRes,oQryRes,nPara:=base:cantprod,oQryArt, nCodart:=0,cDetArt:=SPACE(30),nCantidad:=1,nTotal:=0,oFontTotal,lRta:=.F.,oError
If( lReceta == nil, lReceta := .T., ) ;







oApp:oServer:Execute("" + "CREATE TEMPORARY TABLE IF NOT EXISTS reseta_temp " +"( `CODART` BIGINT(14) NOT NULL," +"`DETART` VARCHAR(60) NOT NULL," +"`CANTIDAD` DECIMAL(10,3) DEFAULT '0'," +"`PUNIT` DECIMAL(12,2) DEFAULT '0.00', " +"`PTOTAL` DECIMAL(12,2) DEFAULT '0.00'," +"PRIMARY KEY (`CODART`)) ENGINE=INNODB DEFAULT CHARSET=utf8")
oApp:oServer:NextResult()
oApp:oServer:Execute("TRUNCATE reseta_temp")
oApp:oServer:NextResult()




oApp:oServer:Execute("INSERT INTO reseta_temp (codart,detart,cantidad,punit,ptotal) "+ "(SELECT r.codusa,a.nombre,r.cantidad,a.preciocos,(r.cantidad * a.preciocos) "+ "FROM ge_"+oApp:cId+"reseta r LEFT JOIN ge_"+oApp:cId+"articu a ON a.codigo = r.codusa "+ "WHERE r.codart = "+ClipValue2SQL(base:codigo)+")")
oApp:oServer:NextResult()
oQryRes:= oApp:oServer:Query("SELECT * FROM reseta_temp")
oQryArt:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu"+IF(lReceta," WHERE  mprima IS TRUE",""))
nPara := IF(lReceta,nPara,1)
oFontTotal := TFont():New( "ARIAL", 12, 30,,,,,,,,,,,,,, )
while .T.
oDlgR = TDialog():New(,,,, IF(lReceta,"Receta Produccion","Stock de Otros"), "RESETA",, .F.,,,,, oForm, .F.,,,,,, .F.,, "oDlgR", nil, )
  oDlgR:lHelpIcon := .F.

  oGet[1] := TGet():ReDefine( 100, { | u | If( PCount()==0, nPara, nPara:= u ) }, oDlgR,, "9999999.999",,,,,,, .F., {||(lReceta)},, .F., .F.,,,,,,, "nPara",,,, )
  IF lReceta


      oGet[2] := TGet():ReDefine( 101, { | u | If( PCount()==0, nCodArt, nCodArt:= u ) }, oDlgR,, "99999999999999", {||(BuscarArt(oQryArt,oDlgR,oGet[2],oGet[3],"1","mprima") .AND. oGet[03]:SetFocus() = nil )},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[2]:cText:= 0, BuscarArt(oQryArt,oDlgR,oGet[2],oGet[3],"1","mprima")) }, "BUSC1", "nCodArt",,,, )
     ELSE


     oGet[2] := TGet():ReDefine( 101, { | u | If( PCount()==0, nCodArt, nCodArt:= u ) }, oDlgR,, "99999999999999", {||(BuscarArt(oQryArt,oDlgR,oGet[2],oGet[3]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[2]:cText:= 0, BuscarArt(oQryArt,oDlgR,oGet[2],oGet[3])) }, "BUSC1", "nCodArt",,,, )
  ENDIF
  oGet[3] := TGet():ReDefine( 102, { | u | If( PCount()==0, cDetArt, cDetArt:= u ) }, oDlgR,, "@!",,,,,,, .F., {||(.F.)},, .F., .F.,,,,,,, "cDetArt",,,, )
  oGet[4] := TGet():ReDefine( 103, { | u | If( PCount()==0, nCantidad, nCantidad:= u ) }, oDlgR,, "9999999.999",,,,,,, .F.,,, .F., .F.,,,,,,, "nCantidad",,,, )

  oGet[5] := TGet():ReDefine( 104, { | u | If( PCount()==0, nTotal, nTotal:= u ) }, oDlgR,, "999999999.99",, 128, 65535, oFontTotal,,, .F., {||(.F.)},, .T., .F.,,,,,,, "nTotal",,,, )






  oBrwRes := XbrowseNew( oDlgR, 0, 0,,,, {"Codigo","Detalle Articulo","Cantidad","Precio U","Total"}, {80,281,60,80,80},,,,,,,,, .F., oQryRes,, .F.,, .F., 300, .F., .F. ,, {"CODART","DETART","CANTIDAD","PUNIT","PTOTAL"},,, .T., .F., .F., .F.,,,,, .F., .F., "oBrwRes", )
    PintaBrw(oBrwRes,0)
    oBrwRes:aCols[5]:nFooterTypE := 1
    oBrwRes:MakeTotals()
    oGet[5]:cText := oBrwRes:aCols[5]:nTotal



    oBrwRes:bKeyDown := { |nKey| IF (nKey == 46,(EliminarItem(oQryRes,oBrwRes,oGet), nTotal:= oBrwRes:aCols[5]:nTotal,oGet[4]:Refresh()),)}
    oDlgR:bKeyDown = { | nKey, nFlags | IF(nKey==120,oBot[3]:Click,.F.) }


  oBot[1] := TButton():ReDefine( 200, {||(AgregaItem(oQryRes,oBrwRes,oGet),oGet[2]:SetFocus())}, oDlgR,,, .F., {||(nCantidad >0 .AND. nCodArt > 0)},,, .F. )

  oBot[2] := TButton():ReDefine( 201, {||(EliminarItem(oQryRes,oBrwRes,oGet),oGet[2]:SetFocus())}, oDlgR,,, .F., {||(oQryRes:RecCount()>0)},,, .F. )
  oBot[3] := TButton():ReDefine( 202, {||(lRta:=.T.,oDlgR:End())}, oDlgR,,, .F.,,,, .F. )
  oBot[4] := TButton():ReDefine( 203, {||(lRta:=.F.,oDlgR:End())}, oDlgR,,, .F.,,,, .T. )
  oBot[5] := TButton():ReDefine( 4001, {||(ActualizarCosto(base,nTotal,nPara))}, oDlgR,,, .F.,,,, .F. )
oDlgR:Activate( oDlgR:bLClicked, oDlgR:bMoved, oDlgR:bPainted, .T.,,, {|Self|oGet[1]:SetFocus()}, oDlgR:bRClicked,,, )

IF !lRta
  RETURN nil
ENDIF
IF lReceta
    base:cantprod:= nPara
    BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
      oApp:oServer:BeginTransaction()
      oApp:oServer:Execute("DELETE FROM ge_"+oApp:cId+"reseta WHERE codart = " +ClipValue2Sql(base:codigo))
      oApp:oServer:NextResult()

      oApp:oServer:Execute("INSERT INTO ge_"+oApp:cId+"reseta (codart,codusa,cantidad) "+ "(SELECT "+ClipValue2Sql(base:codigo)+",codart,cantidad FROM reseta_temp)")


      oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"articu SET cantprod = "+ClipValue2Sql(base:cantprod)+","+ "produccion = TRUE "+ "WHERE codigo = "+ClipValue2Sql(base:codigo))
      oApp:oServer:CommitTransaction()
    RECOVER USING oError
        ValidaError(oError)
      LOOP
    end
   ELSE
    BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
      oApp:oServer:BeginTransaction()
      oApp:oServer:Execute("DELETE FROM ge_"+oApp:cId+"reseta WHERE codart = " +ClipValue2Sql(base:codigo))
      oApp:oServer:NextResult()

      oApp:oServer:Execute("INSERT INTO ge_"+oApp:cId+"reseta (codart,codusa,cantidad) "+ "(SELECT "+ClipValue2Sql(base:codigo)+",codart,cantidad FROM reseta_temp)")

      oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"articu SET stockotro = TRUE "+ "WHERE codigo = "+ClipValue2Sql(base:codigo))
      oApp:oServer:CommitTransaction()
    RECOVER USING oError
        ValidaError(oError)
      LOOP
    end
ENDIF
EXIT
ENDDO
RETURN nil


STATIC FUNCTION ActualizarCosto(base,nTotal,nPara)
LOCAL nCosto
nCosto:= ROUND(nTotal/nPara,2)

oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"articu SET precossiva = "+ClipValue2Sql(nCosto)+" "+ "WHERE codigo = "+ClipValue2Sql(base:codigo))
base:precossiva:= nCosto

msginfo("El precio de costo del articulo ha sido actualizado con exito")
RETURN nil



STATIC FUNCTION ValidaArtR(nCodArt,oGet, oDlg)
LOCAL oQryValid:= oApp:oServer:Query("SELECT codigo,nombre FROM ge_"+oApp:cId+"articu WHERE codigo = "+ ClipValue2Sql(nCodArt)+" and mprima = TRUE")
IF oQryValid:RecCount() > 0
   oGet[03]:cText:= oQryValid:nombre
ELSE
   BuscarArt(oQryValid,oDlg,oGet[02],oGet[03],"TRUE","mprima")
ENDIF
RETURN .T.




STATIC FUNCTION AgregaItem(oQryRes,oBrwRes,oGet)
LOCAL oError
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()



oApp:oServer:Execute("INSERT INTO reseta_temp (codart,detart,cantidad,punit,ptotal) "+ "(SELECT "+ClipValue2SQL(oGet[2]:cText)+",a.nombre,"+ClipValue2Sql(oGet[4]:cText)+ ",a.preciocos,"+ClipValue2Sql(oGet[4]:cText)+"*a.preciocos "+ "FROM ge_"+oApp:cId+"articu a WHERE codigo = "+ClipValue2Sql(oGet[2]:cText)+")")
RECOVER USING oError
    ValidaError(oError)
end
oQryRes:Refresh()
oBrwRes:Refresh()
oBrwRes:MakeTotals()
oGet[5]:cText := oBrwRes:aCols[5]:nTotal
RETURN nil



STATIC FUNCTION EliminarItem(oQryRes,oBrwRes,oGet)
oQryRes:DELETE()
oBrwRes:Refresh()
oQryRes:Refresh()
oBrwRes:Maketotals()
oGet[5]:cText := oBrwRes:aCols[5]:nTotal
RETURN .T.




STATIC FUNCTION CalcularPrecio(oGet,base,lventa)
IF lventa
   IF oGet[46]:lChecked
      oGet[20]:cText:=base:preciocos + (base:preciocos * base:porcentaje)/100
      ELSE
      oGet[20]:cText:=INT(base:preciocos + (base:preciocos * base:porcentaje)/100)
   ENDIF
ELSE
   IF oGet[46]:lChecked
      oGet[19]:cText:=base:preciocos + (base:preciocos * base:porcentajerev)/100
      ELSE
      oGet[19]:cText:=INT(base:preciocos + (base:preciocos * base:porcentajerev)/100)
   ENDIF
ENDIF
RETURN .T.




STATIC FUNCTION Duplicar()


LOCAL oGet := ARRAY(53), oBot := ARRAY(8), oForm, lRta := .F., aCor, base, cProve:=SPACE(30), nNeto, cIvaNom:=SPACE(30), cMarc:=SPACE(30), cRub:=SPACE(30), cDept:=SPACE(30), cEmp:=SPACE(30), nIva,oError,nPrecioven:=0, nova1,nova2,oSay:=ARRAY(8),oGru:=ARRAY(2)

oQry:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu WHERE codigo = " + ClipValue2Sql(oQryBrw:codigo))
   base := oQry:GetRowObj()
   oQry2:GoTop()
   IF oQry2:Seek(base:prov,1) > 0
      cProve := oQry2:nombre
   ENDIF
   oQry3:GoTop()
   IF oQry3:Seek(base:iva,1) > 0
      cIvaNom := STR(oQry3:tasa,6,2) + "%"
   ENDIF
   oQry4:GoTop()
   IF oQry4:Seek(base:marca,1) > 0
      cMarc := oQry4:nombre
   ENDIF
   oQry5:GoTop()
   IF oQry5:Seek(base:rubro,1) > 0
      cRub := oQry5:nombre
   ENDIF
   oQry6:GoTop()
   IF oQry6:Seek(base:depto,1) > 0
      cDept := oQry6:nombre
   ENDIF
   oQry7:GoTop()
   IF oQry7:Seek(base:empresa,1) > 0
      cEmp := oQry7:nombre
   ENDIF
   base:nombre:=SPACE(50)
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"articu")
   base:stockotro := .F.


while .T.
oForm = TDialog():New(,,,, "Duplicado de Articulo", "ABMART1",, .F.,,,,, oWnd1, .F.,,,,,, .F.,, "oForm", nil, )
 oForm:lHelpIcon := .F.

oGet[01] := TGet():ReDefine( 100, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,, "99999999999999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:codigo",,,, )

  oGet[02] := TGet():ReDefine( 101, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,, "@!", {||(base:nombre<>space(30))},,,,,, .F.,,, .F., .F.,,,,,,, "base:nombre",,,, )
  oGet[03] := TGet():ReDefine( 102, { | u | If( PCount()==0, base:nomregi, base:nomregi:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:nomregi",,,, )
  oSay[8] := TSay():ReDefine( 4002,, oForm,,,, .F.,, .F., .F., )
  oGet[51] := TGet():ReDefine( 4017, { | u | If( PCount()==0, base:codigopro, base:codigopro:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:codigopro",,,, )
  oGet[46] := TCheckBox():ReDefine( 4012, { | u | If( PCount()==0, base:endolares, base:endolares:= u ) }, oForm,,,,,,, .F.,, )
  oGet[52] := TCheckBox():ReDefine( 4011, { | u | If( PCount()==0, base:pesable, base:pesable:= u ) }, oForm,,,,,,, .F.,, )
  oGet[34] := TCheckBox():ReDefine( 103, { | u | If( PCount()==0, base:nosale, base:nosale:= u ) }, oForm,,,,,,, .F.,, )

  oGru[1] := TGroup():ReDefine( 401,, oForm,,,, )
  oGet[44] := TCheckBox():ReDefine( 4007, { | u | If( PCount()==0, base:mprima, base:mprima:= u ) }, oForm,,,,,,, .F.,, )
  oGet[45] := TCheckBox():ReDefine( 4008, { | u | If( PCount()==0, base:produccion, base:produccion:= u ) }, oForm,,,,,,, .F.,, )
  oBot[3] := TButton():ReDefine( 4009, {||(Reseta(base,oForm),oGet[06]:Refresh())}, oForm,,, .F., {|| (base:produccion)},,, .F. )




  oGet[04] := TGet():ReDefine( 104, { | u | If( PCount()==0, base:prov, base:prov:= u ) }, oForm,, "99999", {||(Buscar(oQry2,oForm,oGet[4],oGet[5]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[04]:cText:= 0, Buscar(oQry2,oForm,oGet[4],oGet[5])) }, "BUSC1", "base:prov",,,, )
  oGet[05] := TGet():ReDefine( 105, { | u | If( PCount()==0, cProve, cProve:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cProve",,,, )


  oGet[21] := TGet():ReDefine( 122, { | u | If( PCount()==0, base:marca, base:marca:= u ) }, oForm,, "9999", {||(Buscar(oQry4,oForm,oGet[21],oGet[22]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[21]:cText:= 0, Buscar(oQry4,oForm,oGet[21],oGet[22])) }, "BUSC1", "base:marca",,,, )
  oGet[22] := TGet():ReDefine( 123, { | u | If( PCount()==0, cMarc, cMarc:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cMarc",,,, )


  oGet[23] := TGet():ReDefine( 124, { | u | If( PCount()==0, base:rubro, base:rubro:= u ) }, oForm,, "9999", {||(Buscar(oQry5,oForm,oGet[23],oGet[24]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[23]:cText:= 0, Buscar(oQry5,oForm,oGet[23],oGet[24])) }, "BUSC1", "base:rubro",,,, )
  oGet[24] := TGet():ReDefine( 125, { | u | If( PCount()==0, cRub, cRub:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cRub",,,, )


  oGet[27] := TGet():ReDefine( 126, { | u | If( PCount()==0, base:empresa, base:empresa:= u ) }, oForm,, "9999", {||(Buscar(oQry7,oForm,oGet[27],oGet[28]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[27]:cText:= 0, Buscar(oQry7,oForm,oGet[27],oGet[28])) }, "BUSC1", "base:empresa",,,, )
  oGet[28] := TGet():ReDefine( 127, { | u | If( PCount()==0, cEmp, cEmp:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cEmp",,,, )


  oGet[25] := TGet():ReDefine( 128, { | u | If( PCount()==0, base:depto, base:depto:= u ) }, oForm,, "9999", {||(Buscar(oQry6,oForm,oGet[25],oGet[26]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[25]:cText:= 0, Buscar(oQry6,oForm,oGet[25],oGet[26])) }, "BUSC1", "base:depto",,,, )
  oGet[26] := TGet():ReDefine( 129, { | u | If( PCount()==0, cDept, cDept:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cDept",,,, )

  oBot[4] := TButton():ReDefine( 301, {||AltaMar()}, oForm,,, .F.,,,, .F. )
  oBot[5] := TButton():ReDefine( 302, {||AltaRub()}, oForm,,, .F.,,,, .F. )
  oBot[6] := TButton():ReDefine( 303, {||AltaEmp()}, oForm,,, .F.,,,, .F. )
  oBot[7] := TButton():ReDefine( 304, {||AltaDep()}, oForm,,, .F.,,,, .F. )


  oGru[2] := TGroup():ReDefine( 402,, oForm,,,, )
  oSay[3] := TSay():ReDefine( 4066,, oForm,,,, .F.,, .F., .F., )
  oSay[4] := TSay():ReDefine( 4067,, oForm,,,, .F.,, .F., .F., )
  oSay[5] := TSay():ReDefine( 4069,, oForm,,,, .F.,, .F., .F., )
  oSay[6] := TSay():ReDefine( 4070,, oForm,,,, .F.,, .F., .F., )
  oSay[7] := TSay():ReDefine( 4071,, oForm,,,, .F.,, .F., .F., )
  oGet[35] := TGet():ReDefine( 135, { | u | If( PCount()==0, base:unimed, base:unimed:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:unimed",,,, )
  oGet[47] := TGet():ReDefine( 500, { | u | If( PCount()==0, base:medida, base:medida:= u ) }, oForm,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:medida",,,, )
  oGet[48] := TGet():ReDefine( 501, { | u | If( PCount()==0, base:entero, base:entero:= u ) }, oForm,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:entero",,,, )
  oGet[49] := TGet():ReDefine( 502, { | u | If( PCount()==0, base:uxbulto, base:uxbulto:= u ) }, oForm,, "99999",,,,,,, .F.,,, .F., .F.,,,,,,, "base:uxbulto",,,, )

  oGet[50] := TGet():ReDefine( 503, { | u | If( PCount()==0, base:pxbulto, base:pxbulto:= u ) }, oForm,, "999999999.99", {||((oGet[06]:cText:= (base:pxbulto/base:uxbulto)) <> "xxx")},,,,,, .F.,,, .F., .F.,,,,,,, "base:pxbulto",,,, )


  oGet[46] := TCheckBox():ReDefine( 4003, { | u | If( PCount()==0, base:siniva, base:siniva:= u ) }, oForm,,,,,,, .F.,, )
  oGet[06] := TGet():ReDefine( 106, { | u | If( PCount()==0, base:precossiva, base:precossiva:= u ) }, oForm,, "999999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:precossiva",,,, )
  oGet[07] := TGet():ReDefine( 107, { | u | If( PCount()==0, base:desc1, base:desc1:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc1",,,, )
  oGet[08] := TGet():ReDefine( 108, { | u | If( PCount()==0, base:desc2, base:desc2:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc2",,,, )
  oGet[09] := TGet():ReDefine( 109, { | u | If( PCount()==0, base:desc3, base:desc3:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc3",,,, )
  oGet[10] := TGet():ReDefine( 110, { | u | If( PCount()==0, base:desc4, base:desc4:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc4",,,, )
  oGet[11] := TGet():ReDefine( 111, { | u | If( PCount()==0, base:desc5, base:desc5:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:desc5",,,, )

  oGet[39] := TGet():ReDefine( 112, { | u | If( PCount()==0, nNeto, nNeto:= u ) }, oForm,, "999999999.99",,,,,,, .F., {||(CalcularNeto(base,oGet))},, .F., .F.,,,,,,, "nNeto",,,, )

  oGet[12] := TGet():ReDefine( 113, { | u | If( PCount()==0, base:impint, base:impint:= u ) }, oForm,, "999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:impint",,,, )
  oGet[13] := TGet():ReDefine( 114, { | u | If( PCount()==0, base:flete, base:flete:= u ) }, oForm,, "99999.9",,,,,,, .F.,,, .F., .F.,,,,,,, "base:flete",,,, )




  oGet[14] := TGet():ReDefine( 115, { | u | If( PCount()==0, base:iva, base:iva:= u ) }, oForm,, "99", {||(Buscar(oQry3,oForm,oGet[14]) .AND.  (oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx")},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[14]:cText:= 0, (Buscar(oQry3,oForm,oGet[14]) .AND.  (oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx")) }, "BUSC1", "base:iva",,,, )
  oGet[15] := TGet():ReDefine( 116, { | u | If( PCount()==0, cIvaNom, cIvaNom:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cIvaNom",,,, )


  oGet[16] := TGet():ReDefine( 117, { | u | If( PCount()==0, base:preciocos, base:preciocos:= u ) }, oForm,, "999999999.99",,,,,,, .F., {||((oGet[16]:cText:= nNeto + base:impint + nNeto * (base:flete/100) + ((nNeto * oQry3:tasa )/100)) = "-999999")},, .F., .F.,,,,,,, "base:preciocos",,,, )

  oGet[17] := TGet():ReDefine( 118, { | u | If( PCount()==0, base:porcentaje, base:porcentaje:= u ) }, oForm,, "999.99", {||(CalcularPrecio(oGet,base,.T.))},,,,,, .F.,,, .F., .F.,,,,,,, "base:porcentaje",,,, )

  oGet[18] := TGet():ReDefine( 119, { | u | If( PCount()==0, base:porcentajerev, base:porcentajerev:= u ) }, oForm,, "999.99", {||(CalcularPrecio(oGet,base,.F.))},,,,,, .F.,,, .F., .F.,,,,,,, "base:porcentajerev",,,, )
  oGet[19] := TGet():ReDefine( 120, { | u | If( PCount()==0, base:reventa, base:reventa:= u ) }, oForm,, "999999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:reventa",,,, )
  oGet[20] := TGet():ReDefine( 121, { | u | If( PCount()==0, base:precioven, base:precioven:= u ) }, oForm,, "999999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:precioven",,,, )



  oSay[1] := TSay():ReDefine( 801,, oForm,,,, .F.,, .F., .F., )
  oGet[41] := TGet():ReDefine( 1300, { | u | If( PCount()==0, nova1, nova1:= u ) }, oForm,,,,,,,,, .F.,,, .F., .F.,,,,,,, "nova1",,,, )
  oGet[29] := TGet():ReDefine( 130, { | u | If( PCount()==0, base:fecultcom, base:fecultcom:= u ) }, oForm,,,,,,,,, .F., {||(.F.)},, .F., .F.,,,,,,, "base:fecultcom",,,, )
  oGet[30] := TGet():ReDefine( 131, { | u | If( PCount()==0, base:fecmod, base:fecmod:= u ) }, oForm,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "base:fecmod",,,, )
  oSay[2] := TSay():ReDefine( 804,, oForm,,,, .F.,, .F., .F., )
  oGet[42] := TGet():ReDefine( 1311, { | u | If( PCount()==0, nova2, nova2:= u ) }, oForm,,,,,,,,, .F.,,, .F., .F.,,,,,,, "nova2",,,, )


  oGet[31] := TGet():ReDefine( 132, { | u | If( PCount()==0, base:stockmin, base:stockmin:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockmin",,,, )
  oGet[32] := TGet():ReDefine( 133, { | u | If( PCount()==0, base:stockact, base:stockact:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockact",,,, )
  oGet[33] := TGet():ReDefine( 134, { | u | If( PCount()==0, base:stockide, base:stockide:= u ) }, oForm,, "99999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "base:stockide",,,, )
  oGet[53] := TCheckBox():ReDefine( 4005, { | u | If( PCount()==0, base:stockotro, base:stockotro:= u ) }, oForm,,,,,,, .F., {||(.F.)}, )
  oBot[8] := TButton():ReDefine( 4015, {||(Reseta(base,oForm,.F.))}, oForm,,, .F., {|| (.F.)},,, .F. )

  oGet[36] := TGet():ReDefine( 136, { | u | If( PCount()==0, base:observa, base:observa:= u ) }, oForm,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "base:observa",,,, )


  oBot[1] := TButton():ReDefine( 137, {||((lRta := .T.), oForm:End() )}, oForm,,, .F.,,,, .F. )

  oBot[2] := TButton():ReDefine( 138, {||((lRta := .F.), oForm:End() )}, oForm,,, .F.,,,, .T. )

oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|(oGet[02]:SetFocus(),EsconderPermisos(oGet,oSay,oGru,oBot))}, oForm:bRClicked,,, )


IF !lRta
   RETURN nil
ENDIF
base:fecmod:= DATE()
base:horamod:= TIME()
oQry:GetBlankRow()
oQry:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQry:Save()
  oQry:Refresh()
  oQryBrw:Refresh(.F.)
  oApp:oServer:CommitTransaction()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil




STATIC FUNCTION calcupre(lis,costo,marca,codiva)
LOCAL iv, precio, por,oQryAux
oQryAux:=oApp:oServer:Query("SELECT tasa FROM ge_"+oApp:cId+"ivas WHERE codigo = " + ClipValue2Sql(codiva))
IF oQryAux:RecCount()>0
 iv:=oQryAux:tasa
 por    := marca
 precio := costo  + costo  * iv/100
 precio := precio + precio * por/100
ELSE
 precio:=0
ENDIF
RETURN ROUND(precio,3)






STATIC FUNCTION cerrar (  )
LOCAL aNueva := {}, i, j
oQryBrw:End()
__mvXRelease( "oQryBrw" )
__mvXRelease( "oQry2" )
oQry2:End()
__mvXRelease( "oQry3" )
oQry3:End()
__mvXRelease( "oQry4" )
oQry4:End()
__mvXRelease( "oQry5" )
oQry5:End()
__mvXRelease( "oQry6" )
oQry6:End()
__mvXRelease( "oQry7" )
oQry7:End()


j := ASCAN(oApp:aVentanas,cVentana)
FOR i := 1 TO LEN(oApp:aVentanas)
    IF i <> j
       AADD(aNueva,oApp:aVentanas[i])
    ENDIF
next
oApp:aVentanas := ACLONE(aNueva)
RETURN .T.



STATIC FUNCTION Baja (  )
LOCAL mrta := .F., oError, nNum := oQryBrw:codigo
IF oQryBrw:codigo = 0
   RETURN nil
ENDIF
IF oApp:oServer:Query("SELECT COUNT(codart) as casos FROM ge_"+oApp:cId+"ventas_det WHERE codart = "+str(nNum)):casos > 0

   MsgStop("No puede borrar este articulo porque tiene"+CHR(10)+ "ventas asociadas","Atencion")
   RETURN nil
ENDIF

IF oApp:oServer:Query("SELECT COUNT(codart) as casos FROM ge_"+oApp:cId+"reseta "+ " WHERE codart = "+str(nNum)+" OR codusa = "+str(nNum)):casos > 0

   MsgStop("No puede borrar este articulo porque tiene"+CHR(10)+ "recetas asociadas","Atencion")
   RETURN nil
ENDIF
IF oApp:oServer:Query("SELECT COUNT(codart) as casos FROM ge_"+oApp:cId+"remitos WHERE facturado is false and codart = "+str(nNum)):casos > 0

   MsgStop("No puede borrar este articulo porque tiene"+CHR(10)+ "remitos asociados","Atencion")
   RETURN nil
ENDIF

mrta := MsgNoYes("Seguro de eliminar"+CHR(10)+ "el registro código N°:"+STR(nNum),"Atencion")
IF !mrta
   RETURN nil
ENDIF
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}

  oApp:oServer:BeginTransaction()
  oApp:oServer:Execute("DELETE FROM ge_"+oApp:cId+"articu WHERE codigo = " + ClipValue2Sql(oQryBrw:codigo))
  oApp:oServer:Execute("DELETE FROM  ge_"+oApp:cId+"gruposdet WHERE codart = "+ClipValue2SQL(oQryBrw:codigo))
  oApp:oServer:Execute("DELETE FROM  ge_"+oApp:cId+"lispredet WHERE codart = "+ClipValue2SQL(oQryBrw:codigo))
  oApp:oServer:CommitTransaction()
  oQryBrw:Refresh(.F.)

RECOVER USING oError
    ValidaError(oError)
end
oBrw:Refresh()
RETURN nil



STATIC FUNCTION Historial()
LOCAL oDlgH,oBot,oBrwH,oQryHist,oGet1,oGet2
oQryHist:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"campre WHERE codigo = " + ClipValue2Sql(oQryBrw:codigo))

oDlgH = TDialog():New( 05, 15, 23, 82, "Historial de precios",,, .F.,,,,, oWnd1, .F., oApp:oIco,,,,, .F.,, "oDlgH", nil, )
   oDlgH:lHelpIcon := .F.
   TSay():New( 07, 05, {|| "Artículo:"}, oDlgH,,, .F., .F., .F., .T.,,,,, .F., .F., .F., .F., .F., .F., .F.,, )
   oGet1 := TGet():New( 05, 30, { | u | If( PCount()==0, oQryBrw:codigo, oQryBrw:codigo:= u ) }, oDlgH,,, "99999999999999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet1", )
   oGet2 := TGet():New( 05, 85, { | u | If( PCount()==0, oQryBrw:nombre, oQryBrw:nombre:= u ) }, oDlgH,,, "@!",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet2", )




   oBrwH := XbrowseNew( oDlgH, 25, 02, 260, 88,, {"ID","Fecha","Precio S/IVA","Precio Costo","Precio Venta 1","Precio Venta 2","Cambió","Motivo"}, {68,75,80,80,80,80,60,100},,,,,,,,, .F., oQryHist,, .F.,, .T.,, .T., .F. ,, {"ID","fecmod","precossiva","preciocos","precioven","reventa","usuario","ip"},,, .F., .F., .F., .F.,,,,, .F., .F., "oBrwH", )
   oBrwH:CreateFromCode()
   PintaBrw(oBrwH,0)
   oBot := TButton():New( 120, 115, "&OK", oDlgH, {|| oDlgH:End()}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot", .F. )
oDlgH:Activate( oDlgH:bLClicked, oDlgH:bMoved, oDlgH:bPainted, .T.,,, {|Self|oGet1:SetFocus()}, oDlgH:bRClicked,,, )
RETURN nil



STATIC FUNCTION FILT( )









LOCAL vMarca,cMarc:=SPACE(30),vRubro,cRub:=SPACE(30),vempresa,cEmp:=SPACE(30), vdepto,cDept:=SPACE(30),vProv,cProve:=SPACE(30),vcodigo,cNomArt:=SPACE(30),vnosale:=.F., vnombre:=SPACE(30),vnomregi:=SPACE(30),vstockmin,vstockact,vstockide,vReventa, vpreciocos,viva,cNomIva:=SPACE(30),vdesc1,vdesc2,vdesc3,vdesc4,vdesc5, vprecioven,vpresugeri,vprecossiva,vpreciopro,vporcentaje,vfecmodd:="  /  /    ",vfecmodh:="  /  /    ", vfecultcomd:="  /  /    ",vfecultcomh:="  /  /    ",oSay1,oSay2, vneto,vimpint,vflete,vunimed,vobserva,cIvaNom:=SPACE(30), oFilt, acor:=ARRAY(4), oBot:=ARRAY(3), lRta:=.F., oGet:=ARRAY(53), cWhere, vpesable:=.F.,vcombustible:=.F.,vmprima:=.F.,vproduccion:=.F., vmedida,ventero,vuxbulto,vpxbulto,vsiniva:=.F.,vcodigopro:=SPACE(30), vstockotro := .F.

oQryArt:=oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu ORDER BY codigo ")

while .T.
oFilt = TDialog():New(,,,, "Filtrado de Articulo", "ABMART1",, .F.,,,,, oWnd1, .F.,,,,,, .F.,, "oFilt", nil, )
 oFilt:lHelpIcon := .F.

  oGet[01] := TGet():ReDefine( 100, { | u | If( PCount()==0, vcodigo, vcodigo:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vcodigo",,,, )
  oGet[02] := TGet():ReDefine( 101, { | u | If( PCount()==0, vnombre, vnombre:= u ) }, oFilt,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "vnombre",,,, )
  oGet[03] := TGet():ReDefine( 102, { | u | If( PCount()==0, vnomregi, vnomregi:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vnomregi",,,, )
  oGet[34] := TCheckBox():ReDefine( 103, { | u | If( PCount()==0, vnosale, vnosale:= u ) },,,,,,,, .F.,, )
  oGet[46] := TCheckBox():ReDefine( 4011, { | u | If( PCount()==0, vpesable, vpesable:= u ) }, oFilt,,,,,,, .F.,, )
  oGet[51] := TGet():ReDefine( 4017, { | u | If( PCount()==0, vcodigopro, vcodigopro:= u ) }, oFilt,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "vcodigopro",,,, )



  oGet[44] := TCheckBox():ReDefine( 4007, { | u | If( PCount()==0, vmprima, vmprima:= u ) }, oFilt,,,,,,, .F.,, )
  oGet[45] := TCheckBox():ReDefine( 4008, { | u | If( PCount()==0, vproduccion, vproduccion:= u ) }, oFilt,,,,,,, .F.,, )



  oGet[04] := TGet():ReDefine( 104, { | u | If( PCount()==0, vprov, vprov:= u ) }, oFilt,,, {||(EMPTY(oGet[04]:cText) .OR. Buscar(oQry2,oFilt,oGet[04],oGet[05]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[04]:cText:= 0, Buscar(oQry2,oFilt,oGet[04],oGet[05])) }, "BUSC1", "vprov",,,, )
  oGet[05] := TGet():ReDefine( 105, { | u | If( PCount()==0, cProve, cProve:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cProve",,,, )


  oGet[21] := TGet():ReDefine( 122, { | u | If( PCount()==0, vmarca, vmarca:= u ) }, oFilt,,, {||(EMPTY(oGet[21]:cText) .OR. Buscar(oQry4,oFilt,oGet[21],oGet[22]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[21]:cText:= 0, Buscar(oQry4,oFilt,oGet[21],oGet[22])) }, "BUSC1", "vmarca",,,, )
  oGet[22] := TGet():ReDefine( 123, { | u | If( PCount()==0, cMarc, cMarc:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cMarc",,,, )


  oGet[23] := TGet():ReDefine( 124, { | u | If( PCount()==0, vrubro, vrubro:= u ) }, oFilt,,, {||(EMPTY(oGet[23]:cText) .OR. Buscar(oQry5,oFilt,oGet[23],oGet[24]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[23]:cText:= 0, Buscar(oQry5,oFilt,oGet[23],oGet[24])) }, "BUSC1", "vrubro",,,, )
  oGet[24] := TGet():ReDefine( 125, { | u | If( PCount()==0, cRub, cRub:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cRub",,,, )


  oGet[27] := TGet():ReDefine( 126, { | u | If( PCount()==0, vempresa, vempresa:= u ) }, oFilt,,, {||(EMPTY(oGet[27]:cText) .OR. Buscar(oQry7,oFilt,oGet[27],oGet[28]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[27]:cText:= 0, Buscar(oQry7,oFilt,oGet[27],oGet[28])) }, "BUSC1", "vempresa",,,, )
  oGet[28] := TGet():ReDefine( 127, { | u | If( PCount()==0, cEmp, cEmp:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cEmp",,,, )


  oGet[25] := TGet():ReDefine( 128, { | u | If( PCount()==0, vdepto, vdepto:= u ) }, oFilt,,, {||(EMPTY(oGet[25]:cText) .OR. Buscar(oQry6,oFilt,oGet[25],oGet[26]))},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[25]:cText:= 0, Buscar(oQry6,oFilt,oGet[25],oGet[26])) }, "BUSC1", "vdepto",,,, )
  oGet[26] := TGet():ReDefine( 129, { | u | If( PCount()==0, cDept, cDept:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cDept",,,, )


  oGet[35] := TGet():ReDefine( 135, { | u | If( PCount()==0, vunimed, vunimed:= u ) }, oFilt,, "@!",,,,,,, .F.,,, .F., .F.,,,,,,, "vunimed",,,, )
  oGet[47] := TGet():ReDefine( 500, { | u | If( PCount()==0, vmedida, vmedida:= u ) }, oFilt,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "vmedida",,,, )
  oGet[48] := TGet():ReDefine( 501, { | u | If( PCount()==0, ventero, ventero:= u ) }, oFilt,, "9999999",,,,,,, .F.,,, .F., .F.,,,,,,, "ventero",,,, )
  oGet[49] := TGet():ReDefine( 502, { | u | If( PCount()==0, vuxbulto, vuxbulto:= u ) }, oFilt,, "99999",,,,,,, .F.,,, .F., .F.,,,,,,, "vuxbulto",,,, )
  oGet[50] := TGet():ReDefine( 503, { | u | If( PCount()==0, vpxbulto, vpxbulto:= u ) }, oFilt,, "999999999.99",,,,,,, .F.,,, .F., .F.,,,,,,, "vpxbulto",,,, )


  oGet[46] := TCheckBox():ReDefine( 4003, { | u | If( PCount()==0, vsiniva, vsiniva:= u ) }, oFilt,,,,,,, .F.,, )
  oGet[06] := TGet():ReDefine( 106, { | u | If( PCount()==0, vprecossiva, vprecossiva:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vprecossiva",,,, )
  oGet[07] := TGet():ReDefine( 107, { | u | If( PCount()==0, vdesc1, vdesc1:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vdesc1",,,, )
  oGet[08] := TGet():ReDefine( 108, { | u | If( PCount()==0, vdesc2, vdesc2:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vdesc2",,,, )
  oGet[09] := TGet():ReDefine( 109, { | u | If( PCount()==0, vdesc3, vdesc3:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vdesc3",,,, )
  oGet[10] := TGet():ReDefine( 110, { | u | If( PCount()==0, vdesc4, vdesc4:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vdesc4",,,, )
  oGet[11] := TGet():ReDefine( 111, { | u | If( PCount()==0, vdesc5, vdesc5:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vdesc5",,,, )
  oGet[39] := TGet():ReDefine( 112, { | u | If( PCount()==0, vNeto, vNeto:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vNeto",,,, )
  oGet[12] := TGet():ReDefine( 113, { | u | If( PCount()==0, vimpint, vimpint:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vimpint",,,, )
  oGet[13] := TGet():ReDefine( 114, { | u | If( PCount()==0, vflete, vflete:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vflete",,,, )




  oGet[14] := TGet():ReDefine( 115, { | u | If( PCount()==0, viva, viva:= u ) }, oFilt,,, {||(EMPTY(oGet[14]:cText) .OR. (Buscar(oQry3,oFilt,oGet[14],oGet[15]) .AND.  ((oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx"))  )},,,,,, .F.,,, .F., .F.,,,,, {|self| (oGet[14]:cText:= 0, Buscar(oQry3,oFilt,oGet[14],oGet[15]), (oGet[15]:cText := STR(oQry3:tasa,6,2) + "%") <> "xxx" ) }, "BUSC1", "viva",,,, )
  oGet[15] := TGet():ReDefine( 116, { | u | If( PCount()==0, cIvaNom, cIvaNom:= u ) }, oFilt,,,,,,,,, .F., {|| (.F.)},, .F., .F.,,,,,,, "cIvaNom",,,, )
  oGet[16] := TGet():ReDefine( 117, { | u | If( PCount()==0, vpreciocos, vpreciocos:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vpreciocos",,,, )
  oGet[17] := TGet():ReDefine( 118, { | u | If( PCount()==0, vporcentaje, vporcentaje:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vporcentaje",,,, )
  oGet[18] := TGet():ReDefine( 119, { | u | If( PCount()==0, vpreciopro, vpreciopro:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vpreciopro",,,, )
  oGet[19] := TGet():ReDefine( 120, { | u | If( PCount()==0, vreventa, vreventa:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vreventa",,,, )
  oGet[20] := TGet():ReDefine( 121, { | u | If( PCount()==0, vprecioven, vprecioven:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vprecioven",,,, )



  oGet[41] := TGet():ReDefine( 1300, { | u | If( PCount()==0, vfecultcomd, vfecultcomd:= u ) }, oFilt,, "@D",,,,,,, .F.,,, .F., .F.,,,,,,, "vfecultcomd",,,, )
  oSay1 := TSay():ReDefine( 802, {|| "Hasta última compra:"}, oFilt,,,, .F.,, .F., .F., )
  oGet[29] := TGet():ReDefine( 130, { | u | If( PCount()==0, vfecultcomh, vfecultcomh:= u ) }, oFilt,, "@D",,,,,,, .F.,,, .F., .F.,,,,,,, "vfecultcomh",,,, )
  oSay2 := TSay():ReDefine( 803, {|| "Desde cambio precio:"}, oFilt,,,, .F.,, .F., .F., )
  oGet[30] := TGet():ReDefine( 131, { | u | If( PCount()==0, vfecmodd, vfecmodd:= u ) }, oFilt,, "@D",,,,,,, .F.,,, .F., .F.,,,,,,, "vfecmodd",,,, )
  oGet[42] := TGet():ReDefine( 1311, { | u | If( PCount()==0, vfecmodh, vfecmodh:= u ) }, oFilt,, "@D",,,,,,, .F.,,, .F., .F.,,,,,,, "vfecmodh",,,, )

  oGet[31] := TGet():ReDefine( 132, { | u | If( PCount()==0, vstockmin, vstockmin:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vstockmin",,,, )
  oGet[32] := TGet():ReDefine( 133, { | u | If( PCount()==0, vstockact, vstockact:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vstockact",,,, )
  oGet[33] := TGet():ReDefine( 134, { | u | If( PCount()==0, vstockide, vstockide:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vstockide",,,, )
  oGet[53] := TCheckBox():ReDefine( 4005, { | u | If( PCount()==0, vstockotro, vstockotro:= u ) }, oFilt,,,,,,, .F.,, )
  oBot[3] := TButton():ReDefine( 4015,, oFilt,,, .F., {||(.F.)},,, .F. )
  oGet[36] := TGet():ReDefine( 136, { | u | If( PCount()==0, vobserva, vobserva:= u ) }, oFilt,,,,,,,,, .F.,,, .F., .F.,,,,,,, "vobserva",,,, )


  oBot[1] := TButton():ReDefine( 137, {||((lRta := .T.), oFilt:End() )}, oFilt,,, .F.,,,, .F. )

  oBot[2] := TButton():ReDefine( 138, {||((lRta := .F.), oFilt:End() )}, oFilt,,, .F.,,, "Quita Filt.", .T. )

oFilt:Activate( oFilt:bLClicked, oFilt:bMoved, oFilt:bPainted, .T.,,, {|Self|oGet[01]:SetFocus()}, oFilt:bRClicked,,, )

IF !lRta
   oQryBrw:SetNewFilter(1,"1=1",.T.)
   oBrw:Refresh()
   RETURN nil
ENDIF













































cWhere = " 1=1 " + IF(EMPTY(vCodigo),""," and CODIGO =" + ClipValue2SQL(VCodigo) + "")  + "" + IF(EMPTY(VNOMBRE),"","  and TRIM(NOMBRE) like '%" + ALLTRIM(VNOMBRE) + "%'")  + "" + IF(EMPTY(Vnomregi),"","  and TRIM(nomregi) like '%" + ALLTRIM(Vnomregi) + "%'")  + "" + IF(EMPTY(vcodigopro),"","  and TRIM(codigopro) like '%" + ALLTRIM(vcodigopro) + "%'")  + "" + IF(!vnosale," and nosale IS FALSE "," and nosale IS TRUE ") + "" + IF(!vpesable,""," and pesable = TRUE ") + "" + IF(!vcombustible,""," and combustible = TRUE") + "" + IF(!vmprima,""," and mprima = TRUE ") + "" + IF(!vproduccion,""," and produccion = TRUE ") + "" + IF(!vstockotro,""," and stockotro = TRUE ") + "" + IF(!vsiniva,""," and siniva = TRUE ") + "" + IF(EMPTY(vProv),""," and prov =" + ClipValue2SQL(vProv) + "")  + "" + IF(EMPTY(vMarca),""," and marca =" + ClipValue2SQL(vMarca) + "")  + "" + IF(EMPTY(vRubro),""," and rubro =" + ClipValue2SQL(vRubro) + "")  + "" + IF(EMPTY(vempresa),""," and empresa =" + ClipValue2SQL(vempresa) + "")  + "" + IF(EMPTY(vdepto),""," and depto =" + ClipValue2SQL(vdepto) + "")  + "" + IF(EMPTY(vStockmin),""," and stockmin =" + ClipValue2SQL(vstockmin) + "")  + "" + IF(EMPTY(vmedida),""," and medida =" + ClipValue2SQL(vmedida) + "")  + "" + IF(EMPTY(ventero),""," and entero =" + ClipValue2SQL(ventero) + "")  + "" + IF(EMPTY(vuxbulto),""," and uxbulto =" + ClipValue2SQL(vuxbulto) + "")  + "" + IF(EMPTY(vpxbulto),""," and pxbulto =" + ClipValue2SQL(vpxbulto) + "")  + "" + IF(EMPTY(vStockact),""," and stockact =" + ClipValue2SQL(vstockact) + "")  + "" + IF(EMPTY(vstockide),""," and stockide =" + ClipValue2SQL(vstockide) + "")  + "" + IF(EMPTY(vunimed),"","  and TRIM(unimed) like '%" + ALLTRIM(vunimed) + "%'") + "" + IF(EMPTY(vpreciocos),""," and preciocos =" + ClipValue2SQL(vpreciocos) + "")  + "" + IF(EMPTY(vporcentaje),""," and porcentaje =" + ClipValue2SQL(vporcentaje) + "")  + "" + IF(EMPTY(vprecossiva),""," and precossiva =" + ClipValue2SQL(vprecossiva) + "")  + "" + IF(EMPTY(vneto),""," and neto =" + ClipValue2SQL(vneto) + "")  + "" + IF(EMPTY(vimpint),""," and impint =" + ClipValue2SQL(vimpint) + "")  + "" + IF(EMPTY(vflete),""," and flete =" + ClipValue2SQL(vflete) + "")  + "" + IF(EMPTY(viva),""," and iva =" + ClipValue2SQL(viva) + "")  + "" + IF(EMPTY(vdesc1),""," and desc1 =" + ClipValue2SQL(vdesc1) + "")  + "" + IF(EMPTY(vdesc2),""," and desc2 =" + ClipValue2SQL(vdesc2) + "")  + "" + IF(EMPTY(vdesc3),""," and desc3 =" + ClipValue2SQL(vdesc3) + "")  + "" + IF(EMPTY(vdesc4),""," and desc4 =" + ClipValue2SQL(vdesc4) + "")  + "" + IF(EMPTY(vdesc5),""," and desc5 =" + ClipValue2SQL(vdesc5) + "")  + "" + IF(EMPTY(vprecioven),""," and precioven =" + ClipValue2SQL(vprecioven) + "")  + "" + IF(EMPTY(vpreciopro),""," and porcentajeven =" + ClipValue2SQL(vpreciopro) + "")  + "" + IF(EMPTY(vreventa),""," and reventa =" + ClipValue2SQL(vreventa) + "")  + "" + IF(vfecultcomd="  /  /    ",""," and fecultcom >" + ClipValue2SQL(CTOD(vfecultcomd)) + "")  + "" + IF(vfecultcomh="  /  /    ",""," and fecultcom <" + ClipValue2SQL(CTOD(vfecultcomh)) + "")  + "" + IF(vfecmodd="  /  /    ",""," and fecmod >" + ClipValue2SQL(CTOD(vfecmodd)) + "")  + "" + IF(vfecmodh="  /  /    ",""," and fecmod <" + ClipValue2SQL(CTOD(vfecmodh)) + "")  + "" + IF(EMPTY(vobserva),"","  and TRIM(observa) like '%" + ALLTRIM(vobserva) + "%'")

EXIT
ENDDO
oQryBrw:SetNewFilter(1,cWhere,.T.)
oBrw:Refresh()
RETURN nil


STATIC FUNCTION FiltrarVen(lTipo)
lTipoArt := lTipo
IF lTipo = nil
   oQryBrw:SetNewFilter(1,"",.T.)
   oWnd1:cTitle("A/B/M de Articulos: TODOS los articulos")
ENDIF
IF lTipo = .T.
   oQryBrw:SetNewFilter(1,"NOSALE IS FALSE",.T.)
   oWnd1:cTitle("A/B/M de Articulos: Solo articulos vendibles")
ENDIF
IF lTipo = .F.
   oQryBrw:SetNewFilter(1,"NOSALE IS TRUE",.T.)
   oWnd1:cTitle("A/B/M de Articulos: Solo articulos NO VENDIBLES")
ENDIF
oBrw:Refresh()
RETURN nil



FUNCTION AltaMar(oForm1)
LOCAL oGet := ARRAY(4), oBot := ARRAY(2), oForm, lRta := .F., aCor, base, oError,poriva,oQryM
   oQryM:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"marcas")
   base := oQryM:GetBlankRow()
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"marcas")

while .T.

oForm = TDialog():New( 05, 15, 13, 65, "Alta de Marca",,, .F.,,,,, oForm1, .F.,,,,,, .F.,, "oForm", nil, )

   TSay():New( 07, 05, {|| "Codigo:"}, oForm,,, .F., .T., .F., .T.,,, 50, 20, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 22, 05, {|| "Nombre:"}, oForm,,, .F., .T., .F., .T.,,, 50, 20, .F., .F., .F., .F., .F., .F., .F.,, )

   oGet[1] := TGet():New( 05, 65, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,,, "99999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet[1]", )

   oGet[2] := TGet():New( 20, 65, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,,, "@!", {||(base:nombre<>SPACE(30))},,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[2]", )

   acor := AcepCanc(oForm)

   oBot[1] := TButton():New( acor[1], acor[2], "&Grabar", oForm, {|| ((lRta := .T.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Cancelar", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|oGet[1]:SetFocus()}, oForm:bRClicked,,, )
IF !lRta
   RETURN nil
ENDIF
IF base:codigo = 0
   MsgStop("Valores no validos","Error")
   LOOP
ENDIF
oQryM:GetBlankRow()
oQryM:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQryM:Save()
  oApp:oServer:CommitTransaction()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil




FUNCTION AltaRub(oForm1)
LOCAL oGet := ARRAY(4), oBot := ARRAY(2), oForm, lRta := .F., aCor, base, oError,cNomDep:=SPACE(30),oQryR
   oQryR:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"rubros")
   base := oQryR:GetBlankRow()
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"rubros")

while .T.

oForm = TDialog():New( 05, 15, 15, 67, "Alta de Rubros",,, .F.,,,,, oForm1, .F.,,,,,, .F.,, "oForm", nil, )

   TSay():New( 07, 05, {|| "Codigo:"}, oForm,,, .F., .T., .F., .T.,,, 50, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 22, 05, {|| "Nombre:"}, oForm,,, .F., .T., .F., .T.,,, 50, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 37, 05, {|| "Departamento:"}, oForm,,, .F., .T., .F., .T.,,, 50, 12, .F., .F., .F., .F., .F., .F., .F.,, )

   oGet[1] := TGet():New( 05, 60, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,,, "99999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet[1]", )

   oGet[2] := TGet():New( 20, 60, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,,, "@!", {||(base:nombre<>SPACE(30))},,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[2]", )


   oGet[3] := TGet():New( 35, 60, { | u | If( PCount()==0, base:depto, base:depto:= u ) }, oForm, 25, 12, "9999", {||(Buscar(oQry6,oForm,oGet[03],oGet[04]))},,,, .F.,, .T.,, .F.,, .F., .T.,, .F., .F.,,,,,,,, {|self| (oGet[03]:cText:= 0, Buscar(oQry6,oForm,oGet[03],oGet[04])) }, "BUSC1", "oGet[3]",,,, )
   oGet[4] := TGet():New( 35, 90, { | u | If( PCount()==0, cNomDep, cNomDep:= u ) }, oForm,,, "@!",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[4]", )

   acor := AcepCanc(oForm)

   oBot[1] := TButton():New( acor[1], acor[2], "&Grabar", oForm, {|| ((lRta := .T.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Cancelar", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|oGet[1]:SetFocus()}, oForm:bRClicked,,, )
IF !lRta
   RETURN nil
ENDIF
IF base:codigo = 0
   MsgStop("Valores no validos","Error")
   LOOP
ENDIF
oQryR:GetBlankRow()
oQryR:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQryR:Save()
  oApp:oServer:CommitTransaction()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil




FUNCTION AltaEmp(oForm1)
LOCAL oGet := ARRAY(3), oBot := ARRAY(2), oForm, lRta := .F., aCor, base,oQryE,oError

   oQryE:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"empresas")
   base := oQryE:GetBlankRow()
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"empresas")

while .T.

oForm = TDialog():New( 05, 15, 12, 60, "Alta de Empresas de articulos",,, .F.,,,,, oForm1, .F.,,,,,, .F.,, "oForm", nil, )
   acor := AcepCanc(oForm)

   TSay():New( 07, 05, {|| "Código:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 22, 05, {|| "Nombre:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )

   oGet[1] := TGet():New( 05, 50, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,,, "9999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet[1]", )
   oGet[2] := TGet():New( 20, 50, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,,, "@!",,,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[2]", )


 oBot[1] := TButton():New( acor[1], acor[2], "&Grabar", oForm, {|| ((lRta := .T.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Cancelar", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|oGet[2]:SetFocus()}, oForm:bRClicked,,, )
IF !lRta
   RETURN nil
ENDIF
IF base:codigo = 0
   MsgStop("Valores no validos","Error")
   LOOP
ENDIF
oQryE:GetBlankRow()
oQryE:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQryE:Save()
  oApp:oServer:CommitTransaction()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil




FUNCTION AltaDep(oForm1)

LOCAL oGet := ARRAY(5), oBot := ARRAY(2), oForm, lRta := .F., aCor, base, cNomIva:=SPACE(25), oQryIva, oChe,oQryD, oError
   oQryIva:= oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"ivas")
   oQryD  := oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"deptos")
   base := oQryD:GetBlankRow()
   base:codigo := oApp:oServer:GetAutoIncrement("ge_"+oApp:cId+"deptos")

while .T.


oForm = TDialog():New( 05, 15, 12, 60, "Alta de Departametos de articulos",,, .F.,,,,, oForm1, .F.,,,,,, .F.,, "oForm", nil, )
   acor := AcepCanc(oForm)

   TSay():New( 07, 05, {|| "Código:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 22, 05, {|| "Nombre:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 37, 05, {|| "Nombre resumido:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 52, 05, {|| "I.V.A:"}, oForm,,, .F., .T., .F., .T.,,, 40, 12, .F., .F., .F., .F., .F., .F., .F.,, )


   oGet[1] := TGet():New( 05, 50, { | u | If( PCount()==0, base:codigo, base:codigo:= u ) }, oForm,,, "9999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet[1]", )


   oGet[2] := TGet():New( 20, 50, { | u | If( PCount()==0, base:nombre, base:nombre:= u ) }, oForm,,, "@!", {||(base:nombre <> SPACE(30))},,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[2]", )








 oBot[1] := TButton():New( acor[1], acor[2], "&Grabar", oForm, {|| ((lRta := .T.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Cancelar", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|oGet[2]:SetFocus()}, oForm:bRClicked,,, )
IF !lRta
   RETURN nil
ENDIF
IF base:codigo = 0
   MsgStop("Valores no validos","Error")
   LOOP
ENDIF
oQryD:GetBlankRow()
oQryD:oRow := base
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oQryD:Save()
  oApp:oServer:CommitTransaction()
RECOVER USING oError
    ValidaError(oError)
  LOOP
end
EXIT
ENDDO
RETURN nil



FUNCTION EsconderPermisos(oGet,oSay,oGru,oBot)
oGet[41]:Hide()
oGet[42]:Hide()
oSay[1]:Hide()
oSay[2]:Hide()
IF !oApp:usar_produccion
   oGru[1]:Hide()
   oGet[44]:Hide()
   oGet[45]:Hide()
   oBot[3]:Hide()
ENDIF
IF !oApp:usar_bultos
    oGru[2]:Hide()
    oSay[3]:Hide()
    oSay[4]:Hide()
    oSay[5]:Hide()
    oSay[6]:Hide()
    oSay[7]:Hide()
    oGet[35]:Hide()
    oGet[47]:Hide()
    oGet[48]:Hide()
    oGet[49]:Hide()
    oGet[50]:Hide()
ENDIF
IF !oApp:usar_tactil
   oGet[52]:Hide()
ENDIF
IF !oApp:usar_codpro
   oSay[8]:Hide()
   oGet[51]:Hide()
ENDIF

RETURN nil




STATIC FUNCTION Importar()


LOCAL oDlg1, acor:= ARRAY(4), mrta:=.F., oBot1, oBot2, oBrwTmp, aCols := {{0,SPACE(50),0,0,0,0,0,0,0,0,0,0,0," "}}, i, cError, cSql, nDePro := 1, oChe
while .T.
oDlg1 = TDialog():New( 03, 15, 35, 140, "Importar Articulos",,, .F.,,,,,, .F.,,,,,, .F.,, "oDlg1", nil, )
   acor := AcepCanc(oDlg1)




   oBrwTmp := XbrowseNew( oDlg1, 20, 05, 465, 180,, {"Codigo", "Descripcion","Costo","Utilidad","Precio Venta","Stock","Prov","Depto","Rubro","Marca","IVA","Utilidad 2","P.Venta 2","Cod.Prov"}, {60,250,50,50,50,50,50,50,50,50,50,50,50,90},,,,,,,,, .F., aCols,, .F.,, .T.,, .F., .F. ,, {1, 2 ,3, 4, 5,6,7,8,9,10,11,12,13,14},,, .F., .T., .T., .T.,,,,, .F., .T., "oBrwTmp", )
   WITH OBJECT oBrwTmp
      :nEditTypes := 1
      :bKeyDown := { |nKey| IF (nKey == 46,oBrwTmp:Delete(),)}
      :CreateFromCode()
   END




   TSay():New( 205, 05, {|| "Use el boton PEGAR para incluir los datos o edite manualmente los campos. "+ "Tenga en cuenta que el codigo de articulo no puede estar ya en la base de datos"+ " y que la tasa de IVA tiene que ser 5 (21%) o 4 (10.5%). Si no"+ " tiene los codigos de proveedor, rubro, marca, etc. el programa los "+ "pondra en 1. Los precios, porcentaje y stock tienen que ser ENTEROS"}, oDlg1,,, .F., .F., .F., .T.,,, 465, 60, .F., .F., .F., .F., .F., .F., .F.,, )
   PintaBrw(oBrwTmp,0)

   oBot1 := TButton():New( 02, 02, "&Pegar", oDlg1, {|| (Procesando(.T.),oBrwTmp:Paste(),Procesando(.F.))}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot1", .F. )
   oChe := TComboBox():New( 02, 100, { | u | If( PCount()==0, nDePro, nDePro:= u ) }, {"Asigna Cod. proveedor a articulo","Asignar código proveedor al proveedor","Asignar a Ambos"}, 120, 10, oDlg1,,,,,, .T.,,, .F.,, .F.,,,,,, "oChe", )

   oBot1 := TButton():New( acor[1], acor[2], "&Importar", oDlg1, {|| ((mrta := .T.), oDlg1:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot1", .F. )

   oBot2 := TButton():New( acor[3], acor[4], "&Cancelar", oDlg1, {|| ((mrta := .F.), oDlg1:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot2", .F. )
oDlg1:Activate( oDlg1:bLClicked, oDlg1:bMoved, oDlg1:bPainted, .T.,,,, oDlg1:bRClicked,,, )
IF !mrta
   RETURN nil
ENDIF

cError := {}
FOR i := 1 TO LEN(aCols)
    IF aCols[i,1] = 0
       AADD(cError,"Columna 1 en posicion " + STR(i,6) + " no puede estar en cero ")
    ENDIF
    IF EMPTY(aCols[i,2])
       AADD(cError,"Columna 2 en posicion " + STR(i,6) + " no puede estar en blanco ")
    ENDIF
    IF aCols[i,3] = 0
       AADD(cError,"Columna 3 en posicion " + STR(i,6) + " no puede estar en cero ")
    ENDIF
    IF aCols[i,5] = 0

       aCols[i,5] := INT(aCols[i,3] * IF(aCols[i,11] = 5,1.21,1.105) * (1 + aCols[i,4]/100))
    ENDIF
    IF aCols[i,11] <> 5 .AND. aCols[i,11] <> 4 .AND. aCols[i,11] <> 0
       AADD(cError,"Columna 11 en posicion " + STR(i,6) + " solo valores de 4 a 5 ")
    ENDIF
    IF aCols[i,13] = 0

       aCols[i,13] := INT(aCols[i,3] * IF(aCols[i,11] = 5,1.21,1.105) * (1 + aCols[i,12]/100))
    ENDIF
NEXT
IF !EMPTY(cError)
   oDlg1 = TDialog():New( 03, 15, 35, 120, "Errores",,, .F.,,,,,, .F.,,,,,, .F.,, "oDlg1", nil, )
   acor := AcepCanc(oDlg1)




   oBrwTmp := XbrowseNew( oDlg1, 20, 05, 365, 180,, {"Error"}, {1000},,,,,,,,, .F., cError,, .F.,, .T.,, .F., .F. ,, {1},,, .F., .T., .T., .T.,,,,, .F., .T., "oBrwTmp", )
   WITH OBJECT oBrwTmp
      :nEditTypes := 1
      :CreateFromCode()
   END
   PintaBrw(oBrwTmp,0)

   oBot1 := TButton():New( acor[1], acor[2], "&Volver", oDlg1, {|| oDlg1:End()}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot1", .F. )
   oDlg1:Activate( oDlg1:bLClicked, oDlg1:bMoved, oDlg1:bPainted, .T.,,,, oDlg1:bRClicked,,, )
   LOOP
ENDIF
EXIT
ENDDO
FOR i := 1 TO LEN(aCols)
    IF aCols[i,7] = 0
       aCols[i,7] := 1
    ENDIF
    IF aCols[i,8] = 0
       aCols[i,8] := 1
    ENDIF
    IF aCols[i,9] = 0
       aCols[i,9] := 1
    ENDIF
    IF aCols[i,10] = 0
       aCols[i,10] := 1
    ENDIF
    IF aCols[i,11] = 0
       aCols[i,11] := 5
    ENDIF
NEXT


cSql := "INSERT INTO ge_"+oApp:cId+"articu "+ " (codigo,nombre,nomregi,nosale,prov,precossiva,iva,preciocos,porcentaje,"+ " precioven,marca,rubro,empresa,depto,fecmod,stockact,siniva,porcentajerev,reventa,codigopro) VALUES "
FOR i := 1 TO LEN(aCols)



















    cSql := cSql + "("+ClipValue2SQL(aCols[i,1]) + "," +  ClipValue2SQL(aCols[i,2]) + "," +  ClipValue2SQL(LEFT(aCols[i,2],15)) + "," +  "FALSE,"+ ClipValue2SQL(aCols[i,7]) + "," +  ClipValue2SQL(aCols[i,3]) + "," +  ClipValue2SQL(aCols[i,11]) + "," +  ClipValue2SQL(aCols[i,3]) + "," +  ClipValue2SQL(aCols[i,4]) + "," +  ClipValue2SQL(aCols[i,5]) + "," +  ClipValue2SQL(aCols[i,10]) + "," +  ClipValue2SQL(aCols[i,9]) + "," +  "1," +  ClipValue2SQL(aCols[i,8]) + "," +  ClipValue2SQL(DATE()) + "," +  ClipValue2SQL(aCols[i,6]) + "," +  "TRUE,"+ ClipValue2SQL(aCols[i,12]) + "," +  ClipValue2SQL(aCols[i,13]) + "," +  IF(nDePro=2,'" "', ClipValue2SQL(aCols[i,14])) + "), "
next
cSql := LEFT(cSql,LEN(cSql)-2)
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
  oApp:oServer:BeginTransaction()
  oApp:oServer:Execute(cSql)
  oApp:oServer:CommitTransaction()
  oQryBrw:Refresh(.T.)
RECOVER USING cError
  MsgStop("Error al Importar"+CHR(10)+cError:description,"Error")
  oApp:oServer:RollBack()
  RETURN nil
end
IF nDePro > 1

    cSql := "INSERT INTO ge_"+oApp:cId+"codpro "+ " (codpro,codart,codarp) VALUES "
    FOR i := 1 TO LEN(aCols)
        IF !EMPTY(aCols[i,14])


           cSql := cSql + "("+ClipValue2SQL(aCols[i,7]) + "," +  ClipValue2SQL(aCols[i,1]) + "," +  ClipValue2SQL(aCols[i,14]) + "), "
        ENDIF
    next
    cSql := LEFT(cSql,LEN(cSql)-2)
    BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
      oApp:oServer:BeginTransaction()
      oApp:oServer:Execute(cSql)
      oApp:oServer:CommitTransaction()
      oQryBrw:Refresh(.T.)
    RECOVER USING cError
      MsgStop("Error al Importar"+CHR(10)+cError:description,"Error")
      oApp:oServer:RollBack()
      RETURN nil
    end
ENDIF
RETURN nil




STATIC FUNCTION Cambiar()

LOCAL oDlgH, acor:= ARRAY(4), mrta:=.F., oBot1, oBot2, nCodNue := 0, i, oError, cSql, oGet1, oGet2
oDlgH = TDialog():New( 03, 15, 14, 55, "Cambiar Codigo de Articulos",,, .F.,,,,,, .F.,,,,,, .F.,, "oDlgH", nil, )
   acor := AcepCanc(oDlgH)
   TSay():New( 07, 05, {|| "Codigo a Cambiar:"}, oDlgH,,, .F., .T., .F., .T.,,, 60, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 22, 05, {|| "Nuevo Código:"}, oDlgH,,, .F., .T., .F., .T.,,, 60, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   oGet1 := TGet():New( 05, 70, { | u | If( PCount()==0, oQryBrw:codigo, oQryBrw:codigo:= u ) }, oDlgH,,, "99999999999999",,,,, .F.,, .T.,, .F., {||(.F.)}, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet1", )
   oGet2 := TGet():New( 20, 70, { | u | If( PCount()==0, nCodNue, nCodNue:= u ) }, oDlgH,,, "99999999999999", {||(nCodNue>0)},,,, .F.,, .T.,, .F.,, .F., .T.,, .F., .F., .F.,, .F.,,,,,,, "oGet2", )

   oBot1 := TButton():New( acor[1], acor[2], "&Cambiar", oDlgH, {|| ((mrta := .T.), oDlgH:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot1", .F. )

   oBot2 := TButton():New( acor[3], acor[4], "&Cancelar", oDlgH, {|| ((mrta := .F.), oDlgH:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot2", .F. )
oDlgH:Activate( oDlgH:bLClicked, oDlgH:bMoved, oDlgH:bPainted, .T.,,,, oDlgH:bRClicked,,, )
IF !mrta
   RETURN nil
ENDIF

IF nCodNue = oQryBrw:codigo
   RETURN nil
ENDIF
IF oApp:oServer:Query("SELECT * FROM ge_"+oApp:cId+"articu WHERE codigo = " +ClipValue2Sql(nCodNue)):nRecCount > 0
   MsgStop("Ese codigo ya existe para otro articulo","Error")
   RETURN nil
ENDIF
Procesando(.T.)
BEGIN SEQUENCE WITH {|oErr| Break( oErr )}
   oApp:oServer:BeginTransaction()


   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"articu SET codigo = "+ClipValue2SQL(nCodNue)+ " WHERE codigo = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"ventas_det SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"campre SET codigo = "+ClipValue2SQL(nCodNue)+ " WHERE codigo = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"codpro SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"compradet SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"gruposdet SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"lispredet SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"pedidos SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"pedprov_det SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"remitos SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"reseta SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"reseta SET codusa = "+ClipValue2SQL(nCodNue)+ " WHERE codusa = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"ventas_det_p SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))

   oApp:oServer:Execute("UPDATE ge_"+oApp:cId+"stoman SET codart = "+ClipValue2SQL(nCodNue)+ " WHERE codart = "+ClipValue2Sql(oQryBrw:codigo))
   oApp:oServer:CommitTransaction()
RECOVER USING oError
   MsgStop("Error al Cambiar"+CHR(10)+oError:description,"Error")
   oApp:oServer:RollBack()
end
Procesando(.F.)
oQryBrw:Refresh()
oBrw:Refresh()
RETURN nil




STATIC FUNCTION BuscarxCod()

LOCAL oDlgH, acor:= ARRAY(4), mrta:=.F., oBot1, oBot2, nCodNue := SPACE(30), i, oError, cSql, oGet1, oGet2
oDlgH = TDialog():New( 03, 15, 10, 65, "Buscar Codigo de Articulos",,, .F.,,,,,, .F.,,,,,, .F.,, "oDlgH", nil, )
   acor := AcepCanc(oDlgH)
   TSay():New( 07, 05, {|| "Codigo a Buscar:"}, oDlgH,,, .F., .T., .F., .T.,,, 60, 12, .F., .F., .F., .F., .F., .F., .F.,, )
   oGet2 := TGet():New( 05, 70, { | u | If( PCount()==0, nCodNue, nCodNue:= u ) }, oDlgH,,,,,,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet2", )

   oBot1 := TButton():New( acor[1], acor[2], "&Buscar", oDlgH, {|| ((mrta := .T.), oDlgH:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .F., "oBot1", .F. )

   oBot2 := TButton():New( acor[3], acor[4], "&Cancelar", oDlgH, {|| ((mrta := .F.), oDlgH:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot2", .F. )
oDlgH:Activate( oDlgH:bLClicked, oDlgH:bMoved, oDlgH:bPainted, .T.,,,, oDlgH:bRClicked,,, )
IF !mrta
   RETURN nil
ENDIF
IF oApp:oServer:Query("SELECT nombre FROM ge_"+oApp:cId+"articu WHERE codigo = "+ClipValue2SQL(nCodNue)):RecCount() = 0
   IF oApp:oServer:Query("SELECT nombre FROM ge_"+oApp:cId+"articu WHERE codigopro = "+ClipValue2SQL(nCodNue)):RecCount() = 0
       MsgInfo("No existe un articulo con el codigo ingresado, por favor verifique los datos","Atencion!")
       RETURN nil
       ELSE
       nCodNue := oApp:oServer:Query("SELECT codigo FROM ge_"+oApp:cId+"articu WHERE codigopro = "+ClipValue2SQL(nCodNue)):codigo
   ENDIF
   ELSE
   nCodNue := VAL(nCodNue)
ENDIF

Formu(.F.,nCodNue)
RETURN NIL




STATIC FUNCTION HistorialVentas()

LOCAL oBot := ARRAY(2), oForm, lRta := .F., aCor, oFont, oFont1, oError, oQryDet, oBrwDet



oQryDet := oApp:oServer:Query("SELECT v.codart,v.cantidad,v.fecha,v.punit, "+ " v.importe*IF(LEFT(nrofac,2)='NC',-1,1) as importe,c.nombre,v.nrofac,v.descu "+ " FROM ge_"+oApp:cId+"ventas_det v LEFT JOIN ge_"+oApp:cId+"clientes c ON c.codigo = v.codcli "+ " WHERE v.codart = "+ClipValue2SQL(oQryBrw:codigo))

oFont := TFont():New( "TAHOMA", 0, -11.5,,,,,,,,,,,,,, )
oFont1 := TFont():New( "Segoe UI Light", 0, -22,,,,,,,,,,,,,, )
oForm = TDialog():New( 05, 15, 25, 130, "Historial de Ventas "+oQryBrw:nombre,,, .F.,,,,, oWnd1, .F.,, oFont,,,, .F.,, "oForm", nil, )
   acor := AcepCanc(oForm)
   TSay():New( 05, 05, {|| "VENTAS DEL PRODUCTO"}, oForm,, oFont1, .F., .F., .F., .T.,,, 300, 14, .F., .F., .F., .F., .F., .F., .F.,, )




   oBrwDet := XbrowseNew( oForm, 25, 05, 400, 100,, {"Fecha","Comprobante","Cliente","Cant.","Unitario","Total","%Desc"}, {70,120,300,70,70,95,60},,,,,,,,, .F., oQryDet,, .F.,, .T.,, .T., .F. ,, {"fecha","nrofac","nombre","cantidad","punit","importe","descu"},,, .T., .F., .T., .T.,,,,, .F., .T., "oBrwDet", )
   oBrwDet:aCols[4]:nFooterType   := 1
   oBrwDet:aCols[6]:nFooterType   := 1
   oBrwDet:MakeTotals()
   oBrwDet:CreateFromCode()
   PintaBrw(oBrwDet,0)


   oBot[1] := TButton():New( acor[1], acor[2], "&Exportar", oForm, {|| (oBrwDet:ToExcel())}, 30, 10,,, .F., .T., .F.,, .F., {||(oQryDet:nRecCount()>0)},, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Salir", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,,, oForm:bRClicked,,, )
RETURN nil




STATIC FUNCTION RepRecetas()
LOCAL oGru, oQry, oRep, oFont1, oFont2





oQry := oApp:oServer:Query("SELECT a.nombre, r.codart,r.codusa,m.nombre AS materia,a.cantprod,r.cantidad, m.preciocos as pcosto, "+ " m.preciocos* r.cantidad AS precio FROM ge_"+oApp:cId+"reseta r "+ " LEFT JOIN ge_"+oApp:cId+"articu a ON a.codigo = r.codart "+ " LEFT JOIN ge_"+oApp:cId+"articu m ON m.codigo = r.codusa "+ IF(lTipoArt == nil,""," WHERE a.nosale = "+ClipValue2SQL(!lTipoArt))+ " ORDER BY r.codart, r.codusa"  )
IF oQry:nRecCount = 0
   MsgStop("No hay datos para listar","Error")
   RETURN nil
ENDIF
     oFont1 := TFont():New( "ARIAL", 0, -8,,,,,,,,,,,,,, )
     oFont2 := TFont():New( "ARIAL", 0, -8,, .T.,,,,,,,,,,,, )





oRep := RptBegin({{|| "Reporte de Recetas "}}, {{|| OemToAnsi(oApp:nomb_emp)} , {||  "Reporte detalle de recetas"}}, {{|| "Hoja:" + STR(oRep:npage,3)} , {||"Fecha:"+DTOC(DATE())}}, {oFont1,oFont2}, {}, .F.,,,, .T.,,, "Reporte detalle de recetas ",, UPPER("CENTER"), UPPER("CENTER") )
oGru := RptAddGroup( {|| oQry:codart}, {|| "Para "+STR(oQry:cantprod,14)+" "+ ALLTRIM(oQry:nombre) + " ("+STR(oQry:codart)+")"}, {|| "Totales"}, {|| 2}, .F. )
  RptAddColumn( {{|| "Codigo"}}, , {{|| oQry:codusa}}, 12, {"99999999999999"} , {|| 1}, .F., ,, .F., .F.,, .F., .F.,,, .F.,, .F.,,, .F.,, {},, )
  RptAddColumn( {{|| "Materia Prima"}}, , {{|| oQry:materia}}, 30, {} , {|| 1}, .F., ,, .F., .F.,, .F., .F.,,, .F.,, .F.,,, .F.,, {},, )
  RptAddColumn( {{|| "Cantidad"}}, , {{|| oQry:cantidad}}, 08, {"999999.99"} , {|| 1}, .F., ,, .F., .F.,, .F., .F.,,, .F.,, .F.,,, .F.,, {},, )
  RptAddColumn( {{|| "Costo"}}, , {{|| oQry:pcosto}}, 10, {} , {|| 1}, .F., ,, .F., .F.,, .F., .F.,,, .F.,, .F.,,, .F.,, {},, )
  RptAddColumn( {{|| "Total Costo"}}, , {{|| oQry:precio}}, 10, {"9999999999.99"} , {|| 1}, .T., ,, .F., .F.,, .F., .F.,,, .F.,, .F.,,, .F.,, {},, )


oRep:oTitle:aFont[1] := {|| 2 }
oRep:bInit := {|| oQry:GoTop() }
oRep:bSkip := {|| oQry:Skip() }

RptEnd()


oRep:Activate(, {|| !oQry:EOF()}, {|| CursorArrow()},, {|| oRep:SayBitmap(.1,.1,"LOGO.BMP",.5,.5)},,,,,,,,, {|oGrp|oRep:NewLine()} )
oQry:End()
oFont1:End() ; oFont1 := nil
oFont2:End() ; oFont2 := nil

RETURN NIL
