#line 203 "c:\harb16\include\hbclass.ch"
DECLARE HBClass  New( cName AS STRING, OPTIONAL SuperParams ) AS CLASS HBClass  Create() AS OBJECT  Instance() AS OBJECT  AddClsMethod( cName AS STRING, @MethodName(), nScope AS NUMERIC, n2 AS NUMERIC, n3 AS NUMERIC )  AddMultiClsData( cType AS STRING, uVal, nScope AS NUMERIC, aDatas AS ARRAY OF STRING )  AddMultiData( cType AS STRING, uVal, nScope AS NUMERIC, aDatas AS ARRAY OF STRING, x AS LOGICAL, lPer AS LOGICAL )  AddMethod( cName AS STRING, @MethodName(), nScope AS NUMERIC )  AddInLine( cName AS STRING, bBlock AS CODEBLOCK, nScope AS NUMERIC )  AddVirtual( cName AS STRING )
#line 91 "C:\FWH16\INCLUDE\fivewin.ch"
         EXTERNAL FW_GT
















extern errorsys











































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































static aFwStack      := {}
#line 4 "CONECTAR.prg"
MEMVAR oApp, nCliente

FUNCTION Conectar()
LOCAL oServer, cDB, lRta, cHost, lLocal, oQryProc, oQryCli
   D_SetCaseSensitive( .T. )
   Set_MyLang( "es_ES" )

   IF ( oServer := ConnectTo(2) ) == NIL


      MsgStop("Internet no responde."+CHR(10)+ "Verifique que el equipo tenga conexion a internet"+CHR(10)+ "Error de conexion")
      __Quit()
   ENDIF

   IF !FILE("BCN.DLL")




      MsgStop("Un archivo fundamental para la ejecucion del programa"+CHR(10)+ "no esta presente. Por favor"+CHR(10)+ "comuniquese con el servicio tecnico."+CHR(10)+ "Verifique que su conexion de internet esta activa.", "Error de Instalacion")
      __Quit()
   ENDIF
   dbUseArea( .T.,, "bcn.dll", "bcn", iif( .T. .OR. .F., ! .F., NIL ), .F. )
   IF neterr( )




      MsgStop("El programa no tiene permisos de lectura en su PC"+CHR(10)+ "Por favor, vuelva a ejecutar el programa con permisos de supervisor."+CHR(10)+ "Haga click derecho en el acceso directo y elija la opcion"+CHR(10)+ "EJECUTAR COMO ADMINISTRADOR.", "Vuelva a intentarlo.")
      __Quit()
   ENDIF
   nCliente := 0
   IF FILE("BCN_administra.DLL")
      oQryCli  := oServer:Query("SELECT id AS codigo,nombre,nomemp FROM config_clientes WHERE pack = 'GE3'")
      IF !MsgGet2("Ingrese cliente","Ingrese Cliente",@nCliente,oQryCli,"pack",'"GE3"',oApp:oWnd,"id")
         __Quit()
      ENDIF
   ENDIF
   IF EMPTY(bcn->id)
      lRta := PrimeraVez(oServer)
      IF !lRta
         bcn->( dbCloseArea() )
         __Quit()
      ENDIF
      ValidarCli(oServer,@cDB,@cHost,@lLocal)
      ELSE
      ValidarCli(oServer,@cDB,@cHost,@lLocal,nCliente)
   ENDIF
   bcn->( dbCloseArea() )
   oServer:End()
   IF ( oServer := ConnectTo(1,cDB,cHost,lLocal) ) == NIL


       MsgStop("Internet no responde."+CHR(10)+ "Verifique que el equipo tenga conexion a internet"+CHR(10)+ "Error de conexion")
      __Quit()
   ENDIF
   oQryProc:= oServer:Query("SELECT id FROM information_schema.processlist WHERE db = '"+cDB+"' AND TIME > 600")
   IF oQryProc:reccount() > 0
     oQryProc:GoTop()
     WHILE !oQryProc:EOF()
        oServer:Execute("KILL "+ClipValue2Sql(oQryProc:id))
        oQryProc:Skip()
     ENDDO
   ENDIF
RETURN oServer


STATIC FUNCTION PrimeraVez(oServer)

LOCAL oGet := ARRAY(2), oBot := ARRAY(2), oForm, lRta := .F., aCor, oError, cMail := SPACE(100), cCode := SPACE(30), oQry, cDB, cHost, lLocal,oServer1
while .T.

oForm = TDialog():New( 05, 15, 19, 65, "Identificacion de usuario",,, .F.,,,,,, .F.,,,,,, .F.,, "oForm", nil, )





   TSay():New( 07, 05, {|| "Gracias por descargar nuestro programa. "+  "Este proceso lo guiara paso a paso para la correcta "+ "instalacion del mismo."+ "Indique a continuacion el mail que utilizo para descargar "+ "el programa y el codigo que le fue suministrado."}, oForm,,, .F., .F., .F., .T.,,, 170, 40, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 52, 05, {|| "E-Mail:"}, oForm,,, .F., .T., .F., .T.,,, 50, 20, .F., .F., .F., .F., .F., .F., .F.,, )
   TSay():New( 67, 05, {|| "Codigo de Validacion:"}, oForm,,, .F., .T., .F., .T.,,, 50, 20, .F., .F., .F., .F., .F., .F., .F.,, )

   oGet[1] := TGet():New( 50, 65, { | u | If( PCount()==0, cMail, cMail:= u ) }, oForm,,, "@S35",,,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[1]", )
   oGet[2] := TGet():New( 65, 65, { | u | If( PCount()==0, cCode, cCode:= u ) }, oForm,,, "@!",,,,, .F.,, .T.,, .F.,, .F., .F.,, .F., .F., .F.,, .F.,,,,,,, "oGet[2]", )

   acor := AcepCanc(oForm)

   oBot[1] := TButton():New( acor[1], acor[2], "&Continuar", oForm, {|| ((lRta := .T.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F., {||(!EMPTY(oGet[1]:cText) .AND. !EMPTY(oGet[2]:cText))},, .F., "oBot[1]", .F. )

   oBot[2] := TButton():New( acor[3], acor[4], "&Cancelar", oForm, {|| ((lRta := .F.), oForm:End() )}, 30, 10,,, .F., .T., .F.,, .F.,,, .T., "oBot[2]", .F. )
oForm:Activate( oForm:bLClicked, oForm:bMoved, oForm:bPainted, .T.,,, {|Self|oGet[1]:SetFocus()}, oForm:bRClicked,,, )
IF !lRta
   RETURN .F.
ENDIF
Procesando(.T.)


oQry := oServer:Query("SELECT * FROM config_clientes WHERE mail = " + ClipValue2Sql(cMail) + " AND code = " + ClipValue2Sql(cCode)+ " AND pack LIKE '%GE%'")
Procesando(.F.)
IF oQry:nRecCount = 0
   MsgStop("La combinacion de mail y codigo ingresados no son validos.","Error")
   LOOP
ENDIF
EXIT
ENDDO
Procesando(.T.)
cDB := ALLTRIM(oQry:base)
oServer1 := ConnectTo(1,cDB, ALLTRIM(oQry:host),oQry:baselocal)

IF oServer1:TableExist( "ge_"+STRTRAN(STR(oQry:id,6)," ","0")+"ventivadet" )

   IF oServer1:Query("SELECT * FROM " + "ge_"+STRTRAN(STR(oQry:id,6)," ","0")+"punto"):nRecCount > 0

      Procesando(.F.)
      IF bcn->(rlock())

             _FIELD->bcn->id := STRTRAN(STR(oQry:id,6)," ","0") ; _FIELD->bcn->mail := cMail
        ENDIF
      bcn->(dbunlock())
      AgregarTerminal(oServer1,oQry:id,2)
      RETURN .T.
   ENDIF
   ELSE
   CorrerScript(oServer,oServer1,oQry:id)
   Procesando(.F.)
   AgregarTerminal(oServer1,oQry:id,1)
ENDIF
IF bcn->(rlock())

   _FIELD->bcn->id := STRTRAN(STR(oQry:id,6)," ","0") ; _FIELD->bcn->mail := cMail
ENDIF
bcn->(dbunlock())
RETURN .T.

STATIC FUNCTION ValidarCli(oServer,cDb,cHost,lLocal,nCliente)
LOCAL oQry, oQry1, cMail
oApp:cId := IF(nCliente=nil .OR. nCliente = 0,bcn->id,STRTRAN(STR(nCliente,6)," ","0"))



oQry  := oServer:Query("SELECT c.*, c.abono * if(c.disc_iva=3,1.21,1) as saldoabono, curdate() as fechact, p.alias FROM config_clientes c "+ " LEFT JOIN perfiles p ON p.id = c.id_perfil "+ "WHERE c.id = " + oApp:cId)
cMail := IF(nCliente=0,bcn->mail,oQry:mail)


oQry1 := oServer:Query("SELECT MIN(vto) as fechavto "+ " FROM config_clientes "+ " WHERE id = "+oApp:cId)
cDB    := ALLTRIM(oQry:base)
cHost  := ALLTRIM(oQry:host)
lLocal := oQry:baselocal


IF oQry:nRecCount = 0

   MsgStop("1- El programa no esta registrado correctamente..."+CHR(10)+ "por favor, ponganse en contacto con el proveedor","Error")
   __Quit()
ENDIF

IF ALLTRIM(oQry:mail) <> ALLTRIM(cMail)

   MsgStop("2- El programa no esta registrado correctamente..."+CHR(10)+ "por favor, ponganse en contacto con el proveedor","Error")
   __Quit()
ENDIF

IF !oQry:activo

   MsgStop("3- El programa no esta activo para esta instalacion..."+CHR(10)+ "por favor, ponganse en contacto con el proveedor","Error")
   __Quit()
ENDIF

IF oQry:demo .AND. oQry:vto < oQry:fechact


   MsgStop("El periodo de prueba ha caducado..."+CHR(10)+ "por favor, ponganse en contacto con el proveedor"+CHR(10)+ "si necesita extender dicho periodo","Periodo Expirado")
   __Quit()
ENDIF

IF oQry:demo









ENDIF
IF !oQry:demo .AND. oQry:fechact > oQry1:fechavto .AND. oQry:saldoabono > 0
   IF oQry:fechact - oQry1:fechavto > 5




      MsgStop("Le recordamos que el vencimiento de su cuota del abono mensual "+ "operaba el día "+DTOC(oQry1:fechavto)+"."+CHR(10)+"Su servicio fue cancelado por falta de pago, "+ "contactese con su proveedor para restaurarlo."+CHR(10)+ "Importe actual del abono mensual: $"+ALLTRIM(STR(oQry:saldoabono,12,2))+chr(10)+ "Alias para realizar la transferencia: "+ALLTRIM(upper(oQry:alias)),"Vencimiento de abono")
      __Quit()
   ENDIF





      MsgStop("SU ABONO ESTA VENCIDO DESDE EL DÍA "+DTOC(oQry1:fechavto)+CHR(10)+CHR(10)+ "Dispone de "+ALLTRIM(STR(5-(oQry:fechact - oQry1:fechavto)))+" días de gracia antes de que se cancele su suscripción."+CHR(10)+CHR(10)+ "Por favor, realice el pago de la misma para poder seguir operando con el sistema."+chr(10)+ "Importe actual del abono mensual: $"+ALLTRIM(STR(oQry:saldoabono,12,2))+chr(10)+ "Alias para realizar la transferencia: "+ALLTRIM(upper(oQry:alias)) ,"Vencimiento de cuota")

ENDIF
oQry:End()
RETURN NIL


STATIC FUNCTION CorrerScript(oServer,oServer1,nId)

LOCAL cText := oServer:Query("SELECT consulta FROM config_importa WHERE id=1"):consulta, aLine, dFecVto := oServer:Query("SELECT curdate() as fecha"):fecha + 7
cText := STRTRAN(cText,"%empresa%",STRTRAN(STR(nId,6)," ","0"))
aLine := hb_ATokens( cText, ";" )
oServer1:MultiQuery( aLine, .T. )
oServer:Execute("UPDATE config_clientes SET activo = true,  Tablas_creadas = true WHERE id = " + STR(nId))
RETURN nil

STATIC FUNCTION AgregarTerminal(oServer,nId,n)

LOCAL cIp,cId := STRTRAN(STR(nId,6)," ","0"), lRta := .F., cPunto := oServer:Query("SELECT COUNT(ip) as cant FROM ge_"+cId+"punto"):cant + 1
cPunto := STR(cPunto)
IF n = 1
   cIP :=  GetNetCardInfo()[1,1]

   oServer:Execute("INSERT INTO ge_"+cId+"punto (ip,caja) "+ " value  (" + ClipValue2SQL(cIp) + ",1)")
   ELSE
   cIP :=  GetNetCardInfo()[1,1]


   lRta := MsgNoYes("Ud. ya posee puntos de venta cargado..."+CHR(10)+ "Realmente quiere agregar otra terminal"+CHR(10)+ "para operar con el sistema?","Atencion")
   IF lRta

      oServer:Execute("INSERT INTO ge_"+cId+"punto (ip,caja) "+ " value  (" + ClipValue2SQL(cIp) + ","+cPunto+")")
   ENDIF
ENDIF

RETURN nil
#line 2 "connto.prg"
FUNCTION ConnectTo( n, cDB , cHost, lLocal)
   LOCAL c
   LOCAL oIni
   LOCAL oServer
   LOCAL cServer, cUser, cPassword, nPort, cDBName,nFlags
   LOCAL oErr












IF n = 1
    cServer := cHost
    nPort := 3317
    nFlags := 0
    cDBName := cDB
    IF lLocal
       cUser := "root"
       cPassword := ""
       IF FILE(".\connect.ini")
           oIni := TIni():New( ".\connect.ini" )
              oServer := nil
              cServer := oIni:Get( "mysql", "host",, cServer )
              cUser := oIni:Get( "mysql", "user",, cUser )
              cPassword := oIni:Get( "mysql", "psw",, cPassword )
              nPort := oIni:Get( "mysql", "port",, nPort )
              cDBName := oIni:Get( "mysql", "dbname",, cDBName )
              nFlags := oIni:Get( "mysql", "flags",, nFlags )

       ENDIF
    ELSE
       cUser := "cesar"
       cPassword := "App_BCN_Cesar12#$"
    ENDIF
    BEGIN SEQUENCE WITH {| oErr | Break( oErr ) }





      oServer := TDolphinSrv():New( cServer, cUser, cPassword, nPort, nFlags, cDBName,,, )

    RECOVER USING oErr
      RETURN NIL
    END
ELSE
    cServer := "app.bcnsoft.com.ar"
    cUser := "cesar"
    cPassword := "App_BCN_Cesar12#$"
    nPort := 3317
    nFlags := 0
    cDBName := "bcn_config"
    BEGIN SEQUENCE WITH {| oErr | Break( oErr ) }





      oServer := TDolphinSrv():New( cServer, cUser, cPassword, nPort, nFlags, cDBName,,, )

    RECOVER USING oErr
      RETURN NIL
    END
ENDIF


RETURN oServer
